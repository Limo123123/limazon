<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Don't Blame Me - Limazon</title>
    <style>
        /* Einfaches Styling für die Seite */
        body { font-family: Arial, sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: #e76f51; }
        #post-form { display: flex; flex-direction: column; gap: 10px; margin-bottom: 30px; }
        #reason-input { padding: 10px; border-radius: 5px; border: 1px solid #ccc; font-size: 16px; resize: vertical; }
        #submit-btn { padding: 10px 15px; border: none; background-color: #2a9d8f; color: white; font-size: 16px; border-radius: 5px; cursor: pointer; }
        #submit-btn:hover { background-color: #264653; }
        .post-card { border: 1px solid #ddd; border-radius: 8px; margin-bottom: 20px; overflow: hidden; }
        .post-header { padding: 10px; background-color: #f9f9f9; font-weight: bold; }
        .post-reason { padding: 15px; }
        .generated-image { width: 100%; height: 150px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }
        .generated-image p { margin: 0; padding: 10px; }
        #error-message { color: red; text-align: center; }
        #login-prompt { text-align: center; padding: 20px; background-color: #fff3cd; border-radius: 8px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Don't Blame Me!</h1>
        <p style="text-align: center;">Etwas ist schiefgelaufen, aber du warst es nicht? Teile es der Welt mit!</p>

        <div id="user-area" style="display: none;">
            <h2>Sende dein "Don't Blame Me"</h2>
            <form id="post-form">
                <textarea id="reason-input" rows="3" placeholder="Was ist passiert?" maxlength="280" required></textarea>
                <button id="submit-btn" type="submit">Absenden</button>
            </form>
        </div>

        <div id="guest-area">
            <p id="login-prompt">Bitte <a href="/account/login.html">logge dich ein</a>, um einen Post zu erstellen.</p>
        </div>

        <div id="error-message"></div>

        <h2>Neueste Posts</h2>
        <div id="posts-container">
            </div>
    </div>

    <script>
        // JavaScript zum Laden und Senden von Posts
        const API_URL = 'https://api.limazon.v6.rocks'; // Passen Sie dies ggf. an Ihre Server-URL an
        const postsContainer = document.getElementById('posts-container');
        const postForm = document.getElementById('post-form');
        const reasonInput = document.getElementById('reason-input');
        const errorMessage = document.getElementById('error-message');
        const userArea = document.getElementById('user-area');
        const guestArea = document.getElementById('guest-area');

        // Funktion zum Rendern eines Bildes basierend auf den Parametern
        function renderImage(params) {
            const imageDiv = document.createElement('div');
            imageDiv.className = 'generated-image';
            imageDiv.style.backgroundColor = params.backgroundColor;
            imageDiv.style.fontFamily = params.fontFamily;
            imageDiv.style.textAlign = params.textAlign;

            const textP = document.createElement('p');
            textP.innerText = "Don't Blame Me";
            textP.style.color = params.textColor;
            textP.style.fontSize = `${params.fontSize}px`;
            textP.style.padding = `${params.padding}px`;

            imageDiv.appendChild(textP);
            return imageDiv;
        }

        // Funktion zum Abrufen und Anzeigen der Posts
        async function fetchPosts() {
            try {
                const response = await fetch(`${API_URL}/api/dont-blame-me`);
                if (!response.ok) throw new Error('Fehler beim Laden der Posts.');
                const data = await response.json();

                postsContainer.innerHTML = ''; // Leere den Container
                data.posts.forEach(post => {
                    const postCard = document.createElement('div');
                    postCard.className = 'post-card';

                    const header = document.createElement('div');
                    header.className = 'post-header';
                    header.innerText = `Von: ${post.username}`;

                    const reason = document.createElement('div');
                    reason.className = 'post-reason';
                    reason.innerText = post.reason;

                    const image = renderImage(post.imageParams);

                    postCard.appendChild(header);
                    postCard.appendChild(reason);
                    postCard.appendChild(image);
                    postsContainer.appendChild(postCard);
                });
            } catch (error) {
                errorMessage.innerText = error.message;
            }
        }

        // Event Listener für das Senden des Formulars
        if (postForm) {
            postForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const reason = reasonInput.value.trim();
                if (!reason) return;

                try {
                    const response = await fetch(`${API_URL}/api/dont-blame-me`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ reason }),
                        credentials: 'include' // Wichtig, um Cookies (Session) mitzusenden
                    });

                    if (response.status === 401) {
                         errorMessage.innerText = 'Sitzung abgelaufen. Bitte neu einloggen.';
                         return;
                    }
                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.error || 'Ein Fehler ist aufgetreten.');
                    }

                    reasonInput.value = ''; // Formular leeren
                    fetchPosts(); // Liste aktualisieren

                } catch (error) {
                    errorMessage.innerText = error.message;
                }
            });
        }
        
        // Prüfen, ob der Nutzer eingeloggt ist
        function checkLoginStatus() {
            // Eine einfache Prüfung. Sie können dies durch Ihre bestehende Logik ersetzen.
            // Angenommen, ein Cookie oder localStorage-Item zeigt den Login-Status an.
            // In Ihrem Fall ist der beste Weg eine "me" Anfrage an den Server
            fetch(`${API_URL}/api/auth/me`, { credentials: 'include' })
                .then(res => {
                    if(res.ok) {
                        userArea.style.display = 'block';
                        guestArea.style.display = 'none';
                    } else {
                        userArea.style.display = 'none';
                        guestArea.style.display = 'block';
                    }
                })
                .catch(() => {
                    userArea.style.display = 'none';
                    guestArea.style.display = 'block';
                });
        }


        // Initiales Laden der Posts und Login-Status prüfen
        fetchPosts();
        checkLoginStatus();
    </script>
</body>
</html>