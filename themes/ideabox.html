<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ideenbox - Limo Community</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* ... (CSS bleibt unverändert) ... */
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f4f4f9;
            color: #333;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: auto;
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1,
        h2 {
            color: #444;
            text-align: center;
        }

        #idea-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
        }

        #idea-form input,
        #idea-form textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }

        #idea-form button {
            padding: 12px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #idea-form button:hover {
            background-color: #0056b3;
        }

        .idea-card {
            background: #fdfdfd;
            border: 1px solid #eee;
            border-left: 5px solid #007bff;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }

        .idea-card h3 {
            margin-top: 0;
            color: #0056b3;
        }

        .idea-card p {
            white-space: pre-wrap;
        }

        .idea-meta {
            font-size: 0.9em;
            color: #777;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 15px;
            color: white;
            font-weight: bold;
            font-size: 0.8em;
            text-transform: uppercase;
        }

        .status-new {
            background-color: #17a2b8;
            border-color: #17a2b8;
        }

        .status-in-progress {
            background-color: #ffc107;
            color: #333;
            border-color: #ffc107;
        }

        .status-done {
            background-color: #28a745;
            border-color: #28a745;
        }

        .status-rejected {
            background-color: #dc3545;
            border-color: #dc3545;
        }

        .admin-controls {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .admin-controls select,
        .admin-controls button {
            padding: 6px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .admin-controls .delete-btn {
            background-color: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        #message-area {
            text-align: center;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
        }

        .message-success {
            background-color: #d4edda;
            color: #155724;
        }

        .message-error {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>

<body>

    <div class="container">
        <header>
            <h1><a href="/" style="text-decoration: none; color: inherit;">Limo Hub</a></h1>
            <h2>Ideenbox der Community</h2>
            <p style="text-align: center;">Hier kannst du neue Ideen und Vorschläge für das Projekt einreichen und
                sehen, was andere vorgeschlagen haben.</p>
        </header>

        <div id="message-area"></div>

        <section id="idea-submission">
            <h3>Neue Idee einreichen</h3>
            <form id="idea-form">
                <input type="text" id="idea-title" placeholder="Titel deiner Idee (z.B. 'Neues Feature für den Shop')"
                    required minlength="5" maxlength="100">
                <textarea id="idea-description" rows="5" placeholder="Beschreibe deine Idee hier ausführlich..."
                    required minlength="10" maxlength="2000"></textarea>
                <button type="submit">Idee abschicken</button>
            </form>
        </section>

        <section id="ideas-list-section">
            <h2>Eingereichte Ideen</h2>
            <div id="ideas-list">
                <p>Lade Ideen...</p>
            </div>
        </section>
    </div>

    <script>
        const API_BASE_URL = 'https://raspberrypi.tail75d81e.ts.net:8443'; // Basis-URL der API
        const ideaForm = document.getElementById('idea-form');
        const ideaTitle = document.getElementById('idea-title');
        const ideaDescription = document.getElementById('idea-description');
        const ideasList = document.getElementById('ideas-list');
        const messageArea = document.getElementById('message-area');
        let currentUser = null;

        // Hilfsfunktion für Fetch-Anfragen, die immer Credentials mitsendet
        const fetchWithCredentials = (url, options = {}) => {
            options.credentials = 'include'; // <-- **DIE WICHTIGSTE ÄNDERUNG**
            return fetch(url, options);
        };

        document.addEventListener('DOMContentLoaded', async () => {
            await fetchCurrentUser();
            await fetchIdeas();
        });

        async function fetchCurrentUser() {
            try {
                // Nutze die neue Hilfsfunktion
                const response = await fetchWithCredentials(`${API_BASE_URL}/api/auth/me`);
                if (response.ok) {
                    currentUser = await response.json();
                } else {
                    console.log('Nutzer ist nicht eingeloggt.');
                    const submissionSection = document.getElementById('idea-submission');
                    submissionSection.innerHTML = '<p style="text-align:center; color: #721c24; background-color: #f8d7da; padding: 10px; border-radius: 5px;">Du musst <a href="/account/login.html">eingeloggt sein</a>, um neue Ideen einreichen zu können.</p>';
                }
            } catch (error) {
                console.error('Fehler beim Abrufen der User-Session:', error);
            }
        }

        ideaForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) {
                showMessage('Bitte zuerst einloggen.', 'error');
                return;
            }

            const title = ideaTitle.value;
            const description = ideaDescription.value;

            try {
                // Nutze die neue Hilfsfunktion
                const response = await fetchWithCredentials(`${API_BASE_URL}/api/ideas`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, description })
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage('Idee erfolgreich eingereicht!', 'success');
                    ideaForm.reset();
                    await fetchIdeas();
                } else {
                    throw new Error(data.error || 'Unbekannter Fehler');
                }
            } catch (error) {
                showMessage(`Fehler: ${error.message}`, 'error');
            }
        });

        async function fetchIdeas() {
            try {
                // Nutze die neue Hilfsfunktion (auch für öffentliche Anfragen, schadet nicht)
                const response = await fetchWithCredentials(`${API_BASE_URL}/api/ideas`);
                if (!response.ok) throw new Error('Ideen konnten nicht geladen werden.');
                const { ideas } = await response.json();
                renderIdeas(ideas);
            } catch (error) {
                ideasList.innerHTML = `<p style="color: red;">${error.message}</p>`;
            }
        }

        function renderIdeas(ideas) {
            // ... (diese Funktion bleibt unverändert) ...
            if (ideas.length === 0) {
                ideasList.innerHTML = '<p>Noch keine Ideen eingereicht. Sei der Erste!</p>';
                return;
            }
            ideasList.innerHTML = ''; // Liste leeren
            ideas.forEach(idea => {
                const card = document.createElement('div');
                card.className = 'idea-card';
                card.id = `idea-${idea._id}`;

                const statusMeta = {
                    'new': { text: 'Neu', class: 'status-new' },
                    'in-progress': { text: 'In Arbeit', class: 'status-in-progress' },
                    'done': { text: 'Erledigt', class: 'status-done' },
                    'rejected': { text: 'Abgelehnt', class: 'status-rejected' }
                };
                const statusInfo = statusMeta[idea.status] || { text: idea.status, class: '' };

                let adminControlsHTML = '';
                if (currentUser && currentUser.isAdmin) {
                    adminControlsHTML = `
                        <div class="admin-controls">
                            <select onchange="updateIdeaStatus('${idea._id}', this.value)">
                                <option value="new" ${idea.status === 'new' ? 'selected' : ''}>Neu</option>
                                <option value="in-progress" ${idea.status === 'in-progress' ? 'selected' : ''}>In Arbeit</option>
                                <option value="done" ${idea.status === 'done' ? 'selected' : ''}>Erledigt</option>
                                <option value="rejected" ${idea.status === 'rejected' ? 'selected' : ''}>Ablehnen</option>
                            </select>
                            <button class="delete-btn" onclick="deleteIdea('${idea._id}')">Löschen</button>
                            <button onclick="banUser('${idea.submitterId}', '${idea.submitterUsername}')">User bannen</button>
                        </div>
                    `;
                }

                card.innerHTML = `
                    <h3>${escapeHTML(idea.title)}</h3>
                    <div class="idea-meta">
                        <span>Eingereicht von: <strong>${escapeHTML(idea.submitterUsername)}</strong> am ${new Date(idea.createdAt).toLocaleDateString('de-DE')}</span>
                        <span class="status-badge ${statusInfo.class}">${statusInfo.text}</span>
                    </div>
                    <p>${escapeHTML(idea.description)}</p>
                    ${adminControlsHTML}
                `;
                ideasList.appendChild(card);
            });
        }

        // ... (showMessage und escapeHTML bleiben unverändert) ...
        function showMessage(text, type) {
            messageArea.textContent = text;
            messageArea.className = `message-${type}`;
            setTimeout(() => { messageArea.textContent = ''; messageArea.className = ''; }, 5000);
        }

        function escapeHTML(str) {
            return str.replace(/[&<>"']/g, function (match) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                }[match];
            });
        }


        // Admin-Funktionen, die nun auch die Hilfsfunktion nutzen
        window.updateIdeaStatus = async function (ideaId, status) {
            try {
                const response = await fetchWithCredentials(`${API_BASE_URL}/api/ideas/${ideaId}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error);
                showMessage(`Status von Idee ${ideaId} auf '${status}' geändert.`, 'success');
                await fetchIdeas();
            } catch (error) {
                showMessage(`Fehler: ${error.message}`, 'error');
            }
        };

        window.deleteIdea = async function (ideaId) {
            if (!confirm('Bist du sicher, dass du diese Idee endgültig löschen möchtest?')) return;
            try {
                const response = await fetchWithCredentials(`${API_BASE_URL}/api/ideas/${ideaId}`, { method: 'DELETE' });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error);
                showMessage('Idee wurde gelöscht.', 'success');
                await fetchIdeas();
            } catch (error) {
                showMessage(`Fehler: ${error.message}`, 'error');
            }
        };

        window.banUser = async function (userId, username) {
            if (!confirm(`Soll der Nutzer "${username}" wirklich von der Ideenbox gebannt werden? Er kann dann keine neuen Ideen mehr einreichen.`)) return;
            try {
                const response = await fetchWithCredentials(`${API_BASE_URL}/api/admin/ideas/ban-user`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userIdToBan: userId })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error);
                showMessage(`Nutzer "${username}" wurde von der Ideenbox gebannt.`, 'success');
            } catch (error) {
                showMessage(`Fehler: ${error.message}`, 'error');
            }
        };

    </script>
</body>

</html>