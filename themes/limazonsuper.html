<!DOCTYPE html>
<html lang="de" class="scroll-smooth">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Limazon - Modern UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.13/jspdf.plugin.autotable.min.js"></script>

    <script>
        tailwind.config = { darkMode: 'class' }
    </script>

    <style>
        body {
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .product {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .product:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }

        .dark .product:hover {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5), 0 8px 10px -6px rgba(0, 0, 0, 0.5);
        }

        .modal {
            transition: opacity 0.2s ease;
        }

        .modal-content {
            transition: transform 0.2s ease;
        }

        .modal.is-open {
            opacity: 1;
            pointer-events: auto;
        }

        .modal.is-open .modal-content {
            transform: scale(1);
        }

        .hidden {
            display: none !important;
        }

        /* Loading Spinner */
        .button-spinner {
            content: "";
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 0.5rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .toast-notification {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            background-color: #1e293b;
            color: #f1f5f9;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            transform: translateY(20px);
        }

        .toast-notification.show {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>

<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200 font-roboto min-h-screen flex flex-col">

    <script>
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark')
        } else {
            document.documentElement.classList.remove('dark')
        }
    </script>

    <header
        class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-md p-4 flex justify-between items-center sticky top-0 z-50 shadow-sm border-b border-slate-200 dark:border-slate-800">
        <div class="flex items-center gap-4">
            <a href="/" class="text-slate-400 hover:text-indigo-500 transition"><i class="fas fa-arrow-left"></i>
                Hub</a>
            <div
                class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-500 to-purple-600">
                Limazon <span class="text-xs text-slate-500 font-normal uppercase tracking-widest">Modern</span></div>
        </div>

        <div class="flex items-center space-x-2 md:space-x-4">
            <div id="user-info" class="text-sm text-slate-600 dark:text-slate-400">
                <span id="customer-name" class="font-bold text-slate-800 dark:text-slate-200">Gast</span>
                <span id="user-balance-display"
                    class="hidden ml-2 bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded text-xs font-mono">
                    <i class="fas fa-coins text-amber-500"></i> $<span id="user-balance">0.00</span>
                </span>
            </div>

            <div id="auth-buttons" class="flex gap-2">
                <button
                    class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition"
                    onclick="openAuthModal('login')">Login</button>
            </div>

            <div id="user-actions" class="hidden flex items-center gap-2">
                <button class="p-2 text-slate-500 hover:text-indigo-500 transition" onclick="openAccountModal()"
                    title="Konto"><i class="fas fa-user-circle text-xl"></i></button>
                <button class="p-2 text-slate-500 hover:text-emerald-500 transition" onclick="showMyInventory()"
                    title="Inventar"><i class="fas fa-box text-xl"></i></button>
                <button class="p-2 text-slate-500 hover:text-amber-500 transition" onclick="openAuctionHouse()"
                    title="Auktionen"><i class="fas fa-gavel text-xl"></i></button>
                <button class="p-2 text-slate-500 hover:text-blue-500 transition" onclick="openStonkMarket()"
                    title="Börse"><i class="fas fa-chart-line text-xl"></i></button>
                <button id="admin-add-btn" class="hidden p-2 text-red-500 hover:text-red-600"
                    onclick="openAddProductModal()" title="Admin: Add Product"><i
                        class="fas fa-plus-circle"></i></button>
                <button class="p-2 text-red-500 hover:bg-red-50 rounded-lg transition" onclick="logout()"
                    title="Logout"><i class="fas fa-sign-out-alt"></i></button>
            </div>

            <button id="theme-toggle"
                class="p-2 text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition">
                <i class="fas fa-adjust"></i>
            </button>

            <button class="relative p-2 text-slate-600 dark:text-slate-300 hover:text-indigo-600 transition"
                onclick="viewCart()">
                <i class="fas fa-shopping-cart text-xl"></i>
                <span id="cart-count"
                    class="absolute top-0 right-0 bg-red-500 text-white rounded-full text-[10px] w-4 h-4 flex items-center justify-center font-bold">0</span>
            </button>
        </div>
    </header>

    <main class="flex-grow p-4 md:p-8 max-w-7xl mx-auto w-full">
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <h1 class="text-3xl font-bold text-slate-800 dark:text-white">Shop</h1>
            <div class="relative w-full md:w-96">
                <input id="search" type="text" placeholder="Suchen..."
                    class="w-full pl-10 pr-4 py-2 border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 rounded-full focus:ring-2 focus:ring-indigo-500 outline-none transition">
                <i class="fas fa-search absolute left-4 top-3 text-slate-400"></i>
            </div>
        </div>

        <div id="loading-status" class="text-center py-10 hidden">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
            <p id="loading-status-message" class="mt-2 text-slate-500 text-sm">Lade...</p>
        </div>

        <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>

        <div id="pagination-controls" class="flex justify-center items-center mt-10 gap-4">
            <button id="prev"
                class="px-4 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition disabled:opacity-50">Zurück</button>
            <span id="page-info" class="text-sm text-slate-500">Seite 1</span>
            <button id="next"
                class="px-4 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition disabled:opacity-50">Weiter</button>
        </div>
    </main>

    <footer
        class="mt-auto border-t border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 py-6 text-center text-slate-500 text-sm">
        © 2025 Limazon Universe
    </footer>

    <div id="product-detail-modal"
        class="modal fixed inset-0 bg-slate-900/90 flex items-center justify-center opacity-0 pointer-events-none z-50 p-4 backdrop-blur-sm">
        <div
            class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-4xl flex flex-col md:flex-row overflow-hidden modal-content transform scale-95 max-h-[90vh]">
            <div class="md:w-1/2 bg-slate-100 dark:bg-slate-700/50 flex items-center justify-center p-8 relative">
                <img id="detail-image" class="max-h-64 object-contain drop-shadow-xl" src="" alt="Product">
                <button class="absolute top-4 left-4 text-slate-400 hover:text-slate-600"
                    onclick="closeProductDetails()"><i class="fas fa-arrow-left"></i></button>
            </div>
            <div class="md:w-1/2 p-8 flex flex-col">
                <div class="flex justify-between items-start">
                    <div>
                        <h2 id="detail-name" class="text-2xl font-bold text-slate-900 dark:text-white mb-1"></h2>
                        <p class="text-sm text-slate-500 font-mono">ID: <span id="detail-id"></span></p>
                    </div>
                    <button class="text-slate-400 hover:text-red-500 md:hidden" onclick="closeProductDetails()"><i
                            class="fas fa-times text-xl"></i></button>
                </div>

                <div class="mt-6 mb-auto">
                    <p id="detail-price" class="text-4xl font-bold text-indigo-600 dark:text-indigo-400"></p>
                    <div class="mt-2 space-y-1">
                        <p id="detail-stock-available" class="text-sm font-medium"></p>
                        <p id="detail-stock-cart" class="text-xs text-indigo-500"></p>
                    </div>
                </div>

                <div class="mt-8 space-y-4">
                    <div class="flex items-center gap-4">
                        <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Menge</label>
                        <input id="detail-qty" type="number" min="1" value="1"
                            class="w-20 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-center outline-none focus:border-indigo-500">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <button id="detail-add-to-cart"
                            class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition">In
                            den Korb</button>
                        <button id="detail-buy-now"
                            class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-xl transition">Kaufen</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="cart-modal"
        class="modal fixed inset-0 bg-slate-900/80 flex items-center justify-end opacity-0 pointer-events-none z-50">
        <div
            class="bg-white dark:bg-slate-800 w-full max-w-md h-full shadow-2xl modal-content transform translate-x-full flex flex-col transition-transform duration-300">
            <div class="p-6 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
                <h2 class="text-xl font-bold text-slate-900 dark:text-white">Dein Warenkorb</h2>
                <button onclick="closeCart()" class="text-slate-400 hover:text-slate-600"><i
                        class="fas fa-times text-xl"></i></button>
            </div>
            <div id="cart-items" class="flex-grow overflow-y-auto p-6 space-y-4"></div>
            <div class="p-6 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-slate-500">Gesamtsumme</span>
                    <span class="text-2xl font-bold text-slate-900 dark:text-white">$<span
                            id="cart-total">0.00</span></span>
                </div>
                <button id="cart-checkout-button"
                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl transition"
                    onclick="checkout()">Zur Kasse gehen</button>
            </div>
        </div>
    </div>

    <div id="checkout-modal"
        class="modal fixed inset-0 bg-slate-900/80 flex items-center justify-center opacity-0 pointer-events-none z-[60] p-4 backdrop-blur-sm">
        <div
            class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-lg modal-content transform scale-95 p-6">
            <h2 class="text-2xl font-bold mb-4 border-b pb-2 dark:border-slate-700">Checkout</h2>
            <div id="checkout-items" class="space-y-2 mb-6 max-h-60 overflow-y-auto"></div>
            <div class="flex justify-between items-center mb-6 pt-4 border-t dark:border-slate-700">
                <span class="font-bold">Total</span>
                <span class="text-xl font-bold text-indigo-600">$<span id="checkout-total">0.00</span></span>
            </div>
            <div class="flex gap-3">
                <button
                    class="flex-1 py-3 text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition"
                    onclick="closeCheckout()">Abbrechen</button>
                <button id="confirm-purchase-button"
                    class="flex-1 py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-bold transition flex justify-center items-center"
                    onclick="confirmPurchase()">
                    <span class="button-text">Bezahlen</span><span class="button-spinner hidden"></span>
                </button>
            </div>
        </div>
    </div>

    <div id="auth-modal"
        class="modal fixed inset-0 bg-slate-900/80 flex items-center justify-center opacity-0 pointer-events-none z-[70] p-4 backdrop-blur-sm">
        <div
            class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-sm modal-content transform scale-95 p-8 relative">
            <button class="absolute top-4 right-4 text-slate-400 hover:text-slate-600" onclick="closeAuthModal()"><i
                    class="fas fa-times"></i></button>
            <h2 id="auth-modal-title" class="text-2xl font-bold text-center mb-6">Login</h2>
            <form id="auth-form" onsubmit="handleAuthFormSubmit(event)" class="space-y-4">
                <input id="auth-username" type="text" placeholder="Username"
                    class="w-full px-4 py-3 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 focus:ring-2 focus:ring-indigo-500 outline-none"
                    required>
                <input id="auth-password" type="password" placeholder="Passwort"
                    class="w-full px-4 py-3 rounded-lg bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 focus:ring-2 focus:ring-indigo-500 outline-none"
                    required>
                <p id="auth-error-message" class="text-red-500 text-sm text-center hidden"></p>
                <button id="auth-submit-button" type="submit"
                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition flex justify-center items-center">
                    <span class="button-text">Anmelden</span><span class="button-spinner hidden"></span>
                </button>
            </form>
            <p class="text-center mt-6 text-sm text-slate-500"><span id="auth-switch-text">Neu hier?</span> <button
                    id="auth-switch-button" class="text-indigo-600 font-bold hover:underline"
                    onclick="switchAuthMode()">Registrieren</button></p>
        </div>
    </div>

    <div id="inventory-modal"
        class="modal fixed inset-0 bg-slate-900/80 flex items-center justify-center opacity-0 pointer-events-none z-[60] p-4">
        <div
            class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-3xl modal-content transform scale-95 flex flex-col max-h-[85vh]">
            <div class="p-4 border-b dark:border-slate-700 flex justify-between items-center">
                <h2 class="text-xl font-bold">Mein Inventar</h2>
                <button onclick="closeMyInventory()" class="text-slate-400"><i class="fas fa-times"></i></button>
            </div>
            <div id="inventory-content" class="p-4 overflow-y-auto grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>
    </div>

    <div id="auction-house-modal"
        class="modal fixed inset-0 bg-slate-900/80 flex items-center justify-center opacity-0 pointer-events-none z-[60] p-4">
        <div
            class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-6xl modal-content transform scale-95 flex flex-col max-h-[90vh]">
            <div
                class="p-4 border-b dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-800/50 rounded-t-xl">
                <div class="flex items-center gap-2">
                    <i class="fas fa-gavel text-amber-500 text-xl"></i>
                    <h2 class="text-xl font-bold">Auktionshaus</h2>
                </div>
                <button onclick="closeAuctionHouse()" class="text-slate-400"><i
                        class="fas fa-times text-xl"></i></button>
            </div>
            <div id="auction-house-content"
                class="p-6 overflow-y-auto grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 bg-slate-100 dark:bg-slate-900/50">
            </div>
        </div>
    </div>

    <div id="stonks-market-modal"
        class="modal fixed inset-0 bg-slate-900/80 flex items-center justify-center opacity-0 pointer-events-none z-[60] p-4">
        <div
            class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-7xl modal-content transform scale-95 flex flex-col max-h-[90vh]">
            <div
                class="p-4 border-b dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-800/50 rounded-t-xl">
                <div class="flex items-center gap-3">
                    <i class="fas fa-chart-line text-blue-500 text-2xl"></i>
                    <h2 class="text-2xl font-bold tracking-tight">LimoStonks</h2>
                    <span id="stonks-next-update-timer"
                        class="text-xs font-mono bg-slate-200 dark:bg-slate-700 px-2 py-1 rounded">00:00</span>
                </div>
                <button onclick="closeStonkMarket()" class="text-slate-400"><i
                        class="fas fa-times text-xl"></i></button>
            </div>
            <div id="stonks-market-content"
                class="p-6 overflow-y-auto grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 bg-slate-100 dark:bg-slate-900/50">
            </div>
        </div>
    </div>

    <div id="sell-product-modal"
        class="modal fixed inset-0 bg-slate-900/80 flex items-center justify-center opacity-0 pointer-events-none z-[70] p-4">
        <div
            class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-sm modal-content transform scale-95 p-6">
            <h2 class="text-xl font-bold mb-4 text-center">Item Verkaufen</h2>
            <div class="bg-slate-50 dark:bg-slate-700 p-3 rounded-lg mb-4 text-sm">
                <p class="font-bold" id="sell-product-name"></p>
                <div class="flex justify-between mt-1 text-slate-500 dark:text-slate-400">
                    <span>Bestand: <span id="sell-product-user-stock"></span></span>
                    <span>Orig: <span id="sell-product-original-price"></span></span>
                </div>
            </div>
            <div class="space-y-3">
                <div><label class="text-xs font-bold uppercase text-slate-500">Menge</label><input id="sell-quantity"
                        type="number" class="w-full p-2 border rounded dark:bg-slate-900 dark:border-slate-600"></div>
                <div><label class="text-xs font-bold uppercase text-slate-500">Preis pro Stück ($)</label><input
                        id="sell-price" type="number"
                        class="w-full p-2 border rounded dark:bg-slate-900 dark:border-slate-600"></div>
            </div>
            <p id="sell-probability" class="text-center text-xs mt-3 text-slate-500">Wahrscheinlichkeit: --%</p>
            <p id="sell-error-message" class="text-center text-xs text-red-500 mt-2 hidden"></p>
            <div class="flex gap-2 mt-4">
                <button onclick="closeSellProductModal()"
                    class="flex-1 py-2 text-slate-500 hover:bg-slate-100 rounded">Abbruch</button>
                <button id="confirm-sell-button"
                    class="flex-1 py-2 bg-emerald-600 text-white rounded font-bold hover:bg-emerald-700">Verkaufen</button>
            </div>
        </div>
    </div>

    <div id="create-auction-modal"
        class="modal fixed inset-0 bg-slate-900/80 flex items-center justify-center opacity-0 pointer-events-none z-[70] p-4">
        <div
            class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-sm modal-content transform scale-95 p-6">
            <h2 class="text-xl font-bold mb-4 text-center">Auktion Starten</h2>
            <div class="text-center mb-4"><img id="create-auction-product-image"
                    class="w-20 h-20 object-cover mx-auto rounded-lg border dark:border-slate-600">
                <p id="create-auction-product-name" class="font-bold mt-2"></p>
                <p class="text-xs text-slate-500">Max: <span id="create-auction-user-stock"></span></p>
            </div>
            <div class="space-y-3">
                <input id="create-auction-quantity"
                    class="w-full p-2 border rounded dark:bg-slate-900 dark:border-slate-600" placeholder="Menge">
                <input id="create-auction-start-bid"
                    class="w-full p-2 border rounded dark:bg-slate-900 dark:border-slate-600"
                    placeholder="Startgebot ($)">
                <select id="create-auction-duration"
                    class="w-full p-2 border rounded dark:bg-slate-900 dark:border-slate-600">
                    <option value="12">12 Stunden</option>
                    <option value="24">24 Stunden</option>
                    <option value="48">48 Stunden</option>
                </select>
            </div>
            <button id="confirm-create-auction-button"
                class="w-full mt-4 bg-amber-500 text-white font-bold py-2 rounded hover:bg-amber-600">Auktion
                Starten</button>
            <button onclick="closeCreateAuctionModal()"
                class="w-full mt-2 text-slate-500 text-sm hover:underline">Abbrechen</button>
        </div>
    </div>

    <div id="auction-detail-modal"
        class="modal fixed inset-0 bg-slate-900/80 flex items-center justify-center opacity-0 pointer-events-none z-[80] p-4">
        <div
            class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-lg modal-content transform scale-95 p-6 relative">
            <button onclick="document.getElementById('auction-detail-modal').classList.remove('is-open')"
                class="absolute top-4 right-4 text-slate-400"><i class="fas fa-times"></i></button>
            <h2 id="auction-detail-name" class="text-xl font-bold mb-4"></h2>
            <div class="flex gap-4 mb-4">
                <img id="auction-detail-image" class="w-32 h-32 object-cover rounded-lg border dark:border-slate-600">
                <div class="flex-1 text-sm space-y-1">
                    <p>Verkäufer: <span id="auction-detail-seller" class="font-semibold"></span></p>
                    <p>Endet: <span id="auction-detail-time" class="font-bold text-red-500"></span></p>
                    <div class="mt-2 bg-slate-50 dark:bg-slate-700 p-2 rounded">
                        <p class="text-xs text-slate-500">Aktuelles Gebot</p>
                        <p class="text-2xl font-bold text-indigo-600 dark:text-indigo-400">$<span
                                id="auction-detail-bid"></span></p>
                        <p class="text-xs">von <span id="auction-detail-highest-bidder">--</span></p>
                    </div>
                </div>
            </div>
            <div class="flex gap-2">
                <input id="bid-amount" type="number"
                    class="flex-1 p-2 border rounded dark:bg-slate-900 dark:border-slate-600" placeholder="Dein Gebot">
                <button id="confirm-bid-button"
                    class="px-6 bg-indigo-600 text-white rounded font-bold hover:bg-indigo-700">Bieten</button>
            </div>
            <p id="auction-detail-error" class="text-red-500 text-xs mt-2 hidden"></p>
        </div>
    </div>

    <div id="stonk-detail-modal"
        class="modal fixed inset-0 bg-slate-900/80 flex items-center justify-center opacity-0 pointer-events-none z-[90] p-4">
        <div
            class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-md modal-content transform scale-95 p-6 relative">
            <button onclick="document.getElementById('stonk-detail-modal').classList.remove('is-open')"
                class="absolute top-4 right-4 text-slate-400"><i class="fas fa-times"></i></button>
            <div class="flex items-center gap-3 mb-4">
                <img id="stonk-detail-image" class="w-12 h-12 rounded-full object-cover">
                <div>
                    <h2 id="stonk-detail-name" class="text-lg font-bold"></h2>
                    <p class="text-2xl font-bold text-slate-700 dark:text-white">$<span id="stonk-detail-price"></span>
                    </p>
                </div>
            </div>
            <div class="bg-slate-50 dark:bg-slate-700/50 p-3 rounded-lg mb-4 text-sm">
                <div class="flex justify-between"><span>Dein Besitz:</span><span id="stonk-portfolio-quantity"
                        class="font-bold">0</span></div>
                <div class="flex justify-between"><span>Ø Kaufpreis:</span><span
                        id="stonk-portfolio-avg-price">$0.00</span></div>
                <div class="flex justify-between border-t border-slate-200 dark:border-slate-600 mt-1 pt-1">
                    <span>Wert:</span><span id="stonk-portfolio-total-value"
                        class="font-bold text-indigo-500">$0.00</span></div>
            </div>
            <div class="p-4 border rounded-lg dark:border-slate-600">
                <div class="flex items-center gap-2 mb-3">
                    <input id="stonk-trade-quantity" type="number"
                        class="w-20 p-2 border rounded text-center dark:bg-slate-900 dark:border-slate-600"
                        placeholder="Menge">
                    <span id="stonk-trade-estimated-value" class="text-sm font-bold text-slate-500 ml-auto">$0.00</span>
                </div>
                <div class="flex gap-2">
                    <button id="stonk-buy-button"
                        class="flex-1 py-2 bg-emerald-600 text-white rounded font-bold hover:bg-emerald-700">Kaufen</button>
                    <button id="stonk-sell-button"
                        class="flex-1 py-2 bg-red-500 text-white rounded font-bold hover:bg-red-600">Verkaufen</button>
                </div>
                <p id="stonk-trade-error" class="text-center text-xs text-red-500 mt-2 hidden"></p>
            </div>
        </div>
    </div>

    <div id="my-portfolio-modal"
        class="modal fixed inset-0 bg-slate-900/80 flex items-center justify-center opacity-0 pointer-events-none z-[87] p-4">
        <div
            class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-4xl modal-content transform scale-95 flex flex-col max-h-[85vh]">
            <div class="p-4 border-b dark:border-slate-700 flex justify-between items-center">
                <h2 class="text-xl font-bold">Mein Portfolio</h2>
                <button onclick="closeMyPortfolio()" class="text-slate-400"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex-grow overflow-auto p-4">
                <table class="w-full text-sm text-left">
                    <thead class="bg-slate-50 dark:bg-slate-700 text-slate-500 uppercase font-bold text-xs">
                        <tr>
                            <th class="p-3">Aktie</th>
                            <th class="p-3 text-right">Menge</th>
                            <th class="p-3 text-right">Wert</th>
                            <th class="p-3 text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody id="my-portfolio-content" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                </table>
            </div>
            <div
                class="p-4 border-t dark:border-slate-700 flex justify-between items-center font-bold bg-slate-50 dark:bg-slate-800/50">
                <span>Gesamtwert</span>
                <span class="text-xl text-indigo-600 dark:text-indigo-400" id="portfolio-total-value">$0.00</span>
            </div>
        </div>
    </div>

    <div id="my-token-codes-modal"
        class="modal fixed inset-0 bg-slate-900/80 flex items-center justify-center opacity-0 pointer-events-none z-[85] p-4">
        <div
            class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-2xl modal-content transform scale-95 flex flex-col max-h-[85vh]">
            <div class="p-4 border-b dark:border-slate-700 flex justify-between items-center">
                <h2 class="text-xl font-bold">Meine Codes</h2>
                <button onclick="closeMyTokenCodesModal()" class="text-slate-400"><i class="fas fa-times"></i></button>
            </div>
            <div id="my-token-codes-content"
                class="p-4 overflow-y-auto flex-grow space-y-2 bg-slate-50 dark:bg-slate-900/50"></div>
            <div class="p-4 border-t dark:border-slate-700 bg-white dark:bg-slate-800">
                <h3 class="text-xs font-bold uppercase text-slate-500 mb-2">Codes Zusammenführen</h3>
                <div class="flex gap-2">
                    <select id="merge-token-value" class="p-2 border rounded dark:bg-slate-900 dark:border-slate-600">
                        <option value="10">10er</option>
                        <option value="50">50er</option>
                        <option value="100">100er</option>
                    </select>
                    <input id="merge-token-count" type="number"
                        class="p-2 border rounded w-20 dark:bg-slate-900 dark:border-slate-600" placeholder="Anzahl">
                    <button onclick="mergeTokenCodes()"
                        class="bg-indigo-600 text-white px-4 rounded hover:bg-indigo-700 transition">Merge</button>
                </div>
                <p id="merge-token-message" class="text-xs text-center mt-1"></p>
            </div>
        </div>
    </div>

    <div id="account-modal" class="modal fixed inset-0 bg-slate-900/80 flex items-center justify-center opacity-0 pointer-events-none z-[60] p-4">
        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg w-full max-w-lg modal-container modal-content transform scale-95">
            <button class="absolute top-3 right-4 text-slate-600 hover:text-red-600 text-3xl" onclick="closeAccountModal()">×</button>
            <h2 class="text-2xl font-bold mb-6 text-center text-slate-900 dark:text-white">Kontoeinstellungen</h2>
            <div class="modal-scroll-content p-2">
                <div class="mb-4 bg-slate-50 dark:bg-slate-700 p-4 rounded-lg">
                    <p class="mb-1"><strong>Benutzername:</strong> <span id="account-username">...</span></p>
                    <p class="mb-1"><strong>Guthaben:</strong> $<span id="account-balance">0.00</span></p>
                    <p><strong>Tokens:</strong> <i class="fas fa-coins text-amber-400"></i> <span id="account-tokens">0</span></p>
                </div>
                
                <div class="mb-6 border-t dark:border-slate-700 pt-4">
                    <label id="infinity-money-label" class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="account-infinity-money" onchange="updateAccountSettings()" class="form-checkbox h-5 w-5 text-indigo-600 rounded">
                        <span class="text-slate-700 dark:text-slate-300">"Infinity Money"-Modus</span>
                    </label>
                    <p id="infinity-money-unlock-info" class="text-xs text-slate-500 mt-1 hidden">Kaufe das teuerste Produkt im Shop, um dies freizuschalten!</p>
                </div>

                <div class="mb-6 border-t dark:border-slate-700 pt-4 space-y-3">
                    <h3 class="text-lg font-semibold mb-2 text-slate-900 dark:text-white">Token Management</h3>
                    
                    <div class="flex gap-2">
                        <input type="text" id="redeem-token-code" placeholder="Code einlösen..." class="flex-1 px-3 py-2 border rounded dark:bg-slate-900 dark:border-slate-600">
                        <button onclick="redeemTokenCode()" class="bg-indigo-500 text-white px-3 py-2 rounded font-bold">OK</button>
                    </div>
                    <p id="redeem-message" class="text-xs text-center min-h-[1rem]"></p>

                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <input type="number" id="dollars-to-tokens-amount" placeholder="$ -> Token" class="w-full px-2 py-1 border rounded dark:bg-slate-900 dark:border-slate-600 text-sm mb-1">
                            <button onclick="convertDollarsToTokens()" class="w-full bg-emerald-600 text-white text-xs py-1 rounded">Wandeln</button>
                        </div>
                        <div>
                            <input type="number" id="tokens-to-dollars-amount" placeholder="Token -> $" class="w-full px-2 py-1 border rounded dark:bg-slate-900 dark:border-slate-600 text-sm mb-1">
                            <button onclick="convertTokensToDollars()" class="w-full bg-amber-600 text-white text-xs py-1 rounded">Wandeln</button>
                        </div>
                    </div>
                    <p id="dollars-to-tokens-message" class="text-xs text-center min-h-[1rem]"></p>
                </div>
                <p id="account-message" class="text-emerald-600 text-sm mb-4 hidden"></p>
            </div>
            <div class="modal-footer flex justify-end pt-4 border-t dark:border-slate-700">
                <button class="bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-md" onclick="closeAccountModal()">Schließen</button>
            </div>
        </div>
    </div>

    <script>
        const LOG_PREFIX = "[Limazon FE]";
        const getApiUrl = () => 'https://raspberrypi.tail75d81e.ts.net:8443/api';
        
        let products = [], filteredProducts = [], cart = [], lastPurchasedCart = [];
        let currentPage = 1, isInitialLoad = true, isServerStarting = false;
        const itemsPerPage = 12, pollingInterval = 15000;
        let pollingTimer = null, loggedInUser = null, currentSellProductId = null;
        let sortState = { key: 'name', direction: 'asc' };
        let auctionUpdateInterval = null, stonkUpdateInterval = null, currentAuctionProductId = null;
        let currentAuthMode = 'login';

        // --- HELPER ---
        function openModal(el) { if (el) { el.classList.remove('pointer-events-none'); setTimeout(() => el.classList.add('is-open'), 10); } }
        function closeModal(el) { if (el) { el.classList.remove('is-open'); setTimeout(() => el.classList.add('pointer-events-none'), 250); } }
        
        // Element sicher holen (vermeidet NULL Fehler)
        const getEl = (id) => document.getElementById(id);
        const setTxt = (id, txt) => { const e = getEl(id); if(e) e.innerText = txt; }

        function showLoadingStatus(m, s = false, h = true) {
            const t = getEl('loading-status'), e = getEl('loading-status-message'), n = getEl('product-list');
            if (!t) return;
            if (m) { e.textContent = m; t.classList.remove('hidden'); if(h) n.classList.add('hidden'); }
            else { t.classList.add('hidden'); n.classList.remove('hidden'); }
        }
        function debounce(t, e) { let n; return (...o) => { clearTimeout(n); n = setTimeout(() => t(...o), e); }; }
        function showToast(m, d = 3000) {
            const t = document.createElement('div'); t.className = 'toast-notification'; t.textContent = m; document.body.appendChild(t);
            requestAnimationFrame(() => t.classList.add('show')); setTimeout(() => { t.classList.remove('show'); t.addEventListener('transitionend', () => t.remove()); }, d);
        }
        function getStockDisplayInfo(s, q, i = false) {
            if (i) return { text: "Digital", cssClass: "text-emerald-500", canAddMore: true, availableToAdd: 999 };
            const a = Math.max(0, s - q), c = a > 0; 
            return { text: a > 0 ? `Verfügbar: ${a}` : "Ausverkauft", cssClass: a>0 ? "text-emerald-500" : "text-red-500", canAddMore: c, availableToAdd: a };
        }
        function copyToClipboard(t) { navigator.clipboard.writeText(t).then(() => showToast(`Code kopiert!`)); }

        // --- CORE ---
        async function loadProducts(t = 'initial') {
            if (t === 'initial') showLoadingStatus("Lade Shop...", true, true);
            try {
                const r = await fetch(`${getApiUrl()}/products`); 
                if (!r.ok) throw new Error();
                const d = await r.json(); 
                products = Array.isArray(d.products) ? d.products.filter(i => i && typeof i.id === 'number') : [];
                applyFiltersAndSort();
            } catch (e) { showLoadingStatus("Verbindungsfehler...", false, true); }
            finally { if (t === 'initial') showLoadingStatus(null); }
        }

        function applyFiltersAndSort() {
            const t = getEl('search').value.toLowerCase();
            let p = products.filter(i => i.name.toLowerCase().includes(t));
            filteredProducts = p; currentPage = 1; renderProducts();
        }

        function renderProducts() {
            const l = getEl('product-list'); l.innerHTML = '';
            const end = currentPage * itemsPerPage, start = end - itemsPerPage, p = filteredProducts.slice(start, end);
            if (p.length === 0) l.innerHTML = `<div class="text-center col-span-full py-10 text-slate-400">Nichts gefunden.</div>`;
            p.forEach(i => {
                const q = cart.find(x => x.id === i.id)?.quantity || 0, info = getStockDisplayInfo(i.stock || 0, q, i.isTokenCard);
                const d = document.createElement('div'); d.className = 'product bg-white dark:bg-slate-800 rounded-xl shadow-sm overflow-hidden flex flex-col h-full cursor-pointer';
                d.onclick = (e) => { if(!e.target.closest('button, input')) showProductDetails(i.id); };
                d.innerHTML = `
                    <div class="relative h-48 bg-slate-100 dark:bg-slate-700 overflow-hidden"><img src="${i.image_url || 'https://via.placeholder.com/300'}" class="w-full h-full object-cover">
                    ${i.isTokenCard ? '<span class="absolute top-2 right-2 bg-purple-600 text-white text-xs px-2 py-1 rounded">Token</span>' : ''}</div>
                    <div class="p-4 flex flex-col flex-grow">
                        <h3 class="font-bold text-slate-800 dark:text-white truncate">${i.name}</h3>
                        <p class="text-xs text-slate-500">ID: ${i.id}</p>
                        <div class="mt-auto pt-4 flex items-end justify-between">
                            <div><p class="text-xl font-bold text-indigo-600 dark:text-indigo-400">${i.price}</p><p class="text-xs ${info.cssClass}">${info.text}</p></div>
                            <button class="bg-indigo-100 dark:bg-slate-700 text-indigo-600 dark:text-indigo-300 p-2 rounded-lg hover:bg-indigo-600 hover:text-white transition" ${!info.canAddMore?'disabled':''} onclick="addToCart(${i.id}, 1)"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>`;
                l.appendChild(d);
            });
            getEl('page-info').textContent = `Seite ${currentPage} / ${Math.ceil(filteredProducts.length/itemsPerPage)||1}`;
            getEl('prev').disabled = currentPage===1;
            getEl('next').disabled = currentPage >= Math.ceil(filteredProducts.length/itemsPerPage);
        }

        const debouncedApplyFiltersAndSort = debounce(applyFiltersAndSort, 300);

        // --- CART ---
        function addToCart(i, q) {
            const qty = parseInt(q); if(isNaN(qty)||qty<1) return;
            const p = products.find(x=>x.id===i); if(!p) return;
            const item = cart.find(x=>x.id===i); const currentQ = item ? item.quantity : 0;
            const max = p.isTokenCard ? 999 : p.stock;
            if(currentQ + qty > max) { showToast('Nicht genug Lagerbestand'); return; }
            if(item) item.quantity += qty;
            else cart.push({id:i, name:p.name, price:parseFloat(p.price.replace('$','')), quantity:qty, isTokenCard:!!p.isTokenCard});
            saveCart(); updateCartUI(); showToast('Hinzugefügt');
        }
        function saveCart() { document.cookie = `cart=${encodeURIComponent(JSON.stringify(cart))}; path=/; max-age=604800`; }
        function loadCart() { const c=document.cookie.split(';').find(r=>r.trim().startsWith("cart=")); if(c) try{cart=JSON.parse(decodeURIComponent(c.split('=')[1]));}catch{} updateCartUI(); }
        function updateCartUI() {
            getEl('cart-count').textContent = cart.reduce((a,b)=>a+b.quantity,0);
            const l = getEl('cart-items'); l.innerHTML = '';
            let total = 0;
            cart.forEach((x, idx) => {
                total += x.price * x.quantity;
                l.innerHTML += `<div class="flex justify-between items-center p-3 bg-slate-50 dark:bg-slate-700/50 rounded-lg">
                    <div><div class="font-bold dark:text-white">${x.name}</div><div class="text-xs text-slate-500">$${x.price} x ${x.quantity}</div></div>
                    <div class="flex items-center gap-2"><span class="font-bold dark:text-indigo-400">$${(x.price*x.quantity).toFixed(2)}</span><button onclick="cart.splice(${idx},1);saveCart();updateCartUI()" class="text-red-500"><i class="fas fa-trash"></i></button></div>
                </div>`;
            });
            getEl('cart-total').textContent = total.toFixed(2);
        }
        function viewCart() { openModal(getEl('cart-modal')); }
        function closeCart() { closeModal(getEl('cart-modal')); }
        function checkout() { if(!loggedInUser){openAuthModal();return;} closeCart(); openModal(getEl('checkout-modal')); 
            getEl('checkout-items').innerHTML = getEl('cart-items').innerHTML;
            getEl('checkout-total').textContent = getEl('cart-total').textContent;
        }
        function closeCheckout() { closeModal(getEl('checkout-modal')); }
        async function confirmPurchase() {
            const btn = getEl('confirm-purchase-button'); btn.disabled=true;
            try {
                const r = await fetch(`${getApiUrl()}/purchase`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({cart}), credentials:'include'});
                if(!r.ok) throw new Error();
                lastPurchasedCart=[...cart]; cart=[]; saveCart(); updateCartUI(); closeCheckout(); openModal(getEl('thank-you-modal'));
                const d=await r.json(); updateUserInfo(d.user); loadProducts('polling');
            } catch { showToast('Fehler beim Kauf'); } finally { btn.disabled=false; }
        }
        function generateInvoice() { const { jsPDF } = window.jspdf; const doc = new jsPDF(); doc.text('Rechnung', 20, 20); doc.autoTable({startY:30, head:[['Item','Menge','Preis']], body:lastPurchasedCart.map(i=>[i.name,i.quantity,`$${i.price}`])}); doc.save('rechnung.pdf'); }

        // --- AUTH ---
        function openAuthModal(m='login') { currentAuthMode=m; openModal(getEl('auth-modal')); getEl('auth-modal-title').textContent = m==='login'?'Login':'Registrieren'; getEl('auth-submit-button').textContent=m==='login'?'Anmelden':'Registrieren'; }
        function closeAuthModal() { closeModal(getEl('auth-modal')); }
        function switchAuthMode() { openAuthModal(currentAuthMode==='login'?'register':'login'); }
        async function handleAuthFormSubmit(e) {
            e.preventDefault();
            const u=getEl('auth-username').value, p=getEl('auth-password').value;
            try {
                const r = await fetch(`${getApiUrl()}/auth/${currentAuthMode}`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:u, password:p}), credentials:'include'});
                const d=await r.json(); if(!r.ok) throw new Error(d.error);
                closeAuthModal(); showToast('Willkommen!'); if(d.user) updateUserInfo(d.user); else openAuthModal('login');
            } catch(ex) { getEl('auth-error-message').innerText=ex.message; getEl('auth-error-message').classList.remove('hidden'); }
        }
        async function checkLoginStatus() { try{const r=await fetch(`${getApiUrl()}/auth/me`,{credentials:'include'}); if(r.ok) updateUserInfo(await r.json());}catch{} }
        function updateUserInfo(u) {
            loggedInUser = u;
            const n = getEl('customer-name'), b = getEl('user-balance');
            if(u) { 
                n.innerText=u.username; b.innerText=(u.balance||0).toFixed(2); 
                getEl('auth-buttons').classList.add('hidden'); 
                getEl('user-actions').classList.remove('hidden'); 
                getEl('user-balance-display').classList.remove('hidden'); 
                if(u.isAdmin) getEl('admin-add-btn').classList.remove('hidden');
                // Auto-update Account Modal values if open
                if(getEl('account-modal').classList.contains('is-open')) openAccountModal();
            } else { 
                n.innerText='Gast'; 
                getEl('auth-buttons').classList.remove('hidden'); 
                getEl('user-actions').classList.add('hidden'); 
                getEl('user-balance-display').classList.add('hidden'); 
            }
        }
        async function logout() { await fetch(`${getApiUrl()}/auth/logout`, {method:'POST', credentials:'include'}); location.reload(); }

        // --- ACCOUNT & INVENTORY ---
        // FIX FÜR DEN FEHLER BEIM ÖFFNEN DES MODALS
        function openAccountModal() { 
            if(loggedInUser) { 
                setTxt('account-username', loggedInUser.username); 
                setTxt('account-balance', loggedInUser.balance.toFixed(2)); 
                setTxt('account-tokens', loggedInUser.tokens || 0);
                
                const cb = getEl('account-infinity-money');
                if(cb) {
                    if (loggedInUser.isAdmin) { cb.checked = true; cb.disabled = true; }
                    else if (loggedInUser.unlockedInfinityMoney) { cb.checked = loggedInUser.infinityMoney; cb.disabled = false; }
                    else { cb.checked = false; cb.disabled = true; }
                }
                openModal(getEl('account-modal')); 
            } else openAuthModal(); 
        }
        function closeAccountModal() { closeModal(getEl('account-modal')); }
        
        async function showMyInventory() {
            if(!loggedInUser){openAuthModal();return;} openModal(getEl('inventory-modal'));
            const c=getEl('inventory-content'); c.innerHTML='Lade...';
            const r=await fetch(`${getApiUrl()}/inventory`, {credentials:'include'}); const d=await r.json();
            c.innerHTML=''; if(!d.inventory.length) c.innerHTML='Leer.';
            d.inventory.forEach(i=>{
                c.innerHTML+=`<div class="flex justify-between items-center p-3 border rounded bg-slate-50 dark:bg-slate-700/50 dark:border-slate-600">
                    <div class="flex gap-3 items-center"><img src="${i.productDetails.image_url}" class="w-10 h-10 rounded object-cover"><div><div class="font-bold dark:text-white">${i.productDetails.name}</div><div class="text-xs text-slate-500">Menge: ${i.quantityOwned}</div></div></div>
                    <div class="flex gap-2"><button onclick="openSell(${i.productId}, ${i.quantityOwned}, '${i.productDetails.name}', '${i.productDetails.price}')" class="text-xs bg-emerald-100 text-emerald-700 px-2 py-1 rounded hover:bg-emerald-200">Verkaufen</button><button onclick="openCreateAuction(${i.productId}, '${i.productDetails.name}', ${i.quantityOwned}, '${i.productDetails.image_url}')" class="text-xs bg-amber-100 text-amber-700 px-2 py-1 rounded hover:bg-amber-200">Auktion</button></div>
                </div>`;
            });
        }
        function closeMyInventory() { closeModal(getEl('inventory-modal')); }

        // --- STONKS ---
        function openStonkMarket() { if(!loggedInUser){openAuthModal();return;} openModal(getEl('stonks-market-modal')); renderStonkMarket(); }
        function closeStonkMarket() { closeModal(getEl('stonks-market-modal')); }
        
        // FIX FÜR DAS LADEN DER BÖRSE
        async function renderStonkMarket() {
            const c=getEl('stonks-market-content'); c.innerHTML='Lade Aktien...';
            try {
                const [pr,pf]=await Promise.all([fetch(`${getApiUrl()}/products`), fetch(`${getApiUrl()}/stonks/portfolio`,{credentials:'include'})]);
                const pData=await pr.json(); const pfData=await pf.json();
                
                // Wir nehmen ALLE Produkte, die KEINE Token-Karten sind und die eine Preis-Angabe haben.
                // Wenn 'currentPrice' fehlt, parsen wir den normalen String-Preis.
                const stocks = pData.products.filter(p => !p.isTokenCard && (p.currentPrice || p.price));
                
                c.innerHTML='';
                if(stocks.length === 0) { c.innerHTML='Keine Aktien verfügbar.'; return; }

                stocks.forEach(s=>{
                    const pfItem = pfData.portfolio.find(x=>x.productId===s.id);
                    const border = pfItem ? 'border-2 border-blue-500' : 'border border-slate-200 dark:border-slate-700';
                    // Sicherer Preis-Fallback
                    const displayPrice = s.currentPrice ? s.currentPrice.toFixed(2) : (parseFloat(s.price.replace('$',''))||0).toFixed(2);
                    
                    c.innerHTML += `<div onclick="openStonkDetail(${s.id})" class="cursor-pointer bg-white dark:bg-slate-800 rounded-lg p-3 shadow hover:shadow-lg transition ${border}">
                        <div class="flex items-center gap-3 mb-2"><img src="${s.image_url}" class="w-10 h-10 rounded object-cover"><div class="font-bold dark:text-white truncate">${s.name}</div></div>
                        <div class="text-2xl font-bold text-slate-700 dark:text-slate-200">$${displayPrice}</div>
                        ${pfItem ? `<div class="text-xs text-blue-500 font-bold mt-1">Besitz: ${pfItem.quantityShares}</div>` : ''}
                    </div>`;
                });
            } catch(e) { c.innerHTML = `Fehler: ${e.message}`; }
        }
        
        async function openStonkDetail(id) {
            openModal(getEl('stonk-detail-modal'));
            // Fetch für Details neu, um sicherzugehen
            const [pr,pf]=await Promise.all([fetch(`${getApiUrl()}/products`), fetch(`${getApiUrl()}/stonks/portfolio`,{credentials:'include'})]);
            const pd=await pr.json(); const fd=await pf.json();
            const s=pd.products.find(x=>x.id===id); const f=fd.portfolio.find(x=>x.productId===id);
            
            const priceVal = s.currentPrice ? s.currentPrice : (parseFloat(s.price.replace('$',''))||0);

            setTxt('stonk-detail-name', s.name); 
            getEl('stonk-detail-image').src=s.image_url; 
            setTxt('stonk-detail-price', priceVal.toFixed(2));
            setTxt('stonk-portfolio-quantity', f?f.quantityShares:0);
            setTxt('stonk-portfolio-avg-price', f?`$${f.averageBuyPrice.toFixed(2)}`:'$0.00');
            setTxt('stonk-portfolio-total-value', f?`$${(f.quantityShares*priceVal).toFixed(2)}`:'$0.00');
            
            getEl('stonk-buy-button').onclick=()=>tradeStonk(id,'buy');
            getEl('stonk-sell-button').onclick=()=>tradeStonk(id,'sell');
        }
        async function tradeStonk(id, type) {
            const q=getEl('stonk-trade-quantity').value;
            // Wichtig: parseInt nutzen
            try{const r=await fetch(`${getApiUrl()}/stonks/${type}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({productId:id, quantity:parseInt(q)}),credentials:'include'});
            if(r.ok){showToast('Order ausgeführt');closeModal(getEl('stonk-detail-modal'));updateUserInfo((await fetch(`${getApiUrl()}/auth/me`,{credentials:'include'})).json());renderStonkMarket();}
            else showToast('Fehler bei der Order');}catch{showToast('Netzwerkfehler');}
        }

        // --- AUCTIONS ---
        function openAuctionHouse() { if(!loggedInUser){openAuthModal();return;} openModal(getEl('auction-house-modal')); renderAuctions(); }
        function closeAuctionHouse() { closeModal(getEl('auction-house-modal')); }
        async function renderAuctions() {
            const c=getEl('auction-house-content'); c.innerHTML='Lade...';
            const r=await fetch(`${getApiUrl()}/auctions`); const d=await r.json();
            c.innerHTML=''; if(!d.auctions.length) c.innerHTML='Keine aktiven Auktionen.';
            d.auctions.forEach(a=>{
                c.innerHTML+=`<div onclick="openAuctionDetail('${a._id}')" class="bg-white dark:bg-slate-800 rounded-lg p-4 shadow cursor-pointer hover:scale-105 transition">
                    <img src="${a.productImageUrl}" class="w-full h-32 object-cover rounded mb-2">
                    <div class="font-bold dark:text-white truncate">${a.productName}</div>
                    <div class="flex justify-between items-end mt-2"><div><div class="text-xs text-slate-500">Gebot</div><div class="text-xl font-bold text-indigo-600">$${a.currentBid}</div></div><div class="text-xs text-red-500 font-bold">Läuft</div></div>
                </div>`;
            });
        }
        async function openAuctionDetail(id) {
            openModal(getEl('auction-detail-modal'));
            const r=await fetch(`${getApiUrl()}/auctions/${id}`); const d=await r.json(); const a=d.auction;
            setTxt('auction-detail-name', a.productName); getEl('auction-detail-image').src=a.productImageUrl;
            setTxt('auction-detail-seller', a.sellerUsername); setTxt('auction-detail-bid', a.currentBid);
            getEl('confirm-bid-button').onclick=async()=>{
                const v=getEl('bid-amount').value;
                try{await fetch(`${getApiUrl()}/auctions/${id}/bid`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({bidAmount:parseFloat(v)}),credentials:'include'});
                showToast('Gebot abgegeben!'); closeModal(getEl('auction-detail-modal')); renderAuctions(); }catch(e){showToast(e.message);}
            };
        }

        // --- SELL & CREATE ---
        function openSell(id, max, name, price) { 
            currentSellProductId=id; 
            setTxt('sell-product-name', name); 
            setTxt('sell-product-user-stock', max); 
            setTxt('sell-product-original-price', price); 
            getEl('sell-quantity').value = 1;
            getEl('sell-quantity').max = max;
            getEl('sell-price').value = parseFloat(price.replace('$','')) || 0;
            openModal(getEl('sell-product-modal')); 
            
            // FIX FÜR 400 BAD REQUEST: parseFloat und parseInt nutzen
            getEl('confirm-sell-button').onclick=async()=>{
                const q = parseInt(getEl('sell-quantity').value);
                const p = parseFloat(getEl('sell-price').value);
                
                try {
                    const r = await fetch(`${getApiUrl()}/products/sell`, {
                        method:'POST',
                        headers:{'Content-Type':'application/json'},
                        body:JSON.stringify({productId:id, quantity:q, sellPrice:p}),
                        credentials:'include'
                    });
                    if(r.ok) {
                        showToast('Verkauft!'); closeModal(getEl('sell-product-modal')); showMyInventory();
                    } else {
                        const d = await r.json();
                        showToast(`Fehler: ${d.error}`);
                    }
                } catch(e) { showToast('Netzwerkfehler'); }
            }
        }
        function closeSellProductModal() { closeModal(getEl('sell-product-modal')); }
        
        function openCreateAuction(id, name, max, img) { 
            currentAuctionProductId=id; 
            setTxt('create-auction-product-name', name); 
            setTxt('create-auction-user-stock', max); 
            getEl('create-auction-product-image').src=img; 
            openModal(getEl('create-auction-modal')); 
            
             getEl('confirm-create-auction-button').onclick=async()=>{
                const q=parseInt(getEl('create-auction-quantity').value);
                const sb=parseFloat(getEl('create-auction-start-bid').value);
                const dur=parseInt(getEl('create-auction-duration').value);
                
                await fetch(`${getApiUrl()}/auctions`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({productId:id, quantity:q, startingBid:sb, durationInHours:dur}),credentials:'include'});
                showToast('Auktion gestartet!'); closeModal(getEl('create-auction-modal')); showMyInventory();
            }
        }
        function closeCreateAuctionModal() { closeModal(getEl('create-auction-modal')); }

        // --- TOKENS ---
        function showMyTokenCodes() { if(!loggedInUser){openAuthModal();return;} openModal(getEl('my-token-codes-modal')); loadMyTokens(); }
        function closeMyTokenCodesModal() { closeModal(getEl('my-token-codes-modal')); }
        async function loadMyTokens() {
            const c=getEl('my-token-codes-content'); c.innerHTML='Lade...';
            const r=await fetch(`${getApiUrl()}/tokens/my-codes`,{credentials:'include'}); const d=await r.json();
            c.innerHTML=''; if(!d.codes.length) c.innerHTML='Keine Codes.';
            d.codes.forEach(x=>{
                c.innerHTML+=`<div class="flex justify-between items-center p-3 bg-slate-50 dark:bg-slate-700/50 rounded border dark:border-slate-600">
                    <div class="font-mono text-sm dark:text-emerald-400">${x.code}</div><div class="text-sm font-bold text-slate-500">${x.tokenAmount} Tokens</div><button onclick="copyToClipboard('${x.code}')" class="text-indigo-500"><i class="fas fa-copy"></i></button>
                </div>`;
            });
        }
        async function redeemTokenCode() { const c=getEl('redeem-token-code').value; await fetch(`${getApiUrl()}/tokens/redeem`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code:c}),credentials:'include'}); showToast('Eingelöst!'); updateUserInfo((await fetch(`${getApiUrl()}/auth/me`,{credentials:'include'})).json()); }
        async function mergeTokenCodes() { const v=getEl('merge-token-value').value, c=getEl('merge-token-count').value; await fetch(`${getApiUrl()}/tokens/merge`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({tokenValue:v, count:c}),credentials:'include'}); showToast('Merged!'); loadMyTokens(); }
        async function convertDollarsToTokens() { const v=getEl('dollars-to-tokens-amount').value; await fetch(`${getApiUrl()}/tokens/convert-dollars-to-tokens`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({dollarAmount:parseFloat(v)}),credentials:'include'}); showToast('Umgewandelt!'); updateUserInfo((await fetch(`${getApiUrl()}/auth/me`,{credentials:'include'})).json()); }
        async function convertTokensToDollars() { const v=getEl('tokens-to-dollars-amount').value; await fetch(`${getApiUrl()}/tokens/convert-tokens-to-dollars`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({tokenAmount:parseInt(v)}),credentials:'include'}); showToast('Umgewandelt!'); updateUserInfo((await fetch(`${getApiUrl()}/auth/me`,{credentials:'include'})).json()); }

        // --- OTHER ---
        function openMyPortfolio() { if (!loggedInUser) return openAuthModal('login'); openModal(getEl('my-portfolio-modal')); }
        function closeMyPortfolio() { closeModal(getEl('my-portfolio-modal')); }
        function showOrderHistory() { if (!loggedInUser) return openAuthModal('login'); openModal(getEl('order-history-modal')); }
        function closeOrderHistory() { closeModal(getEl('order-history-modal')); }
        function openAddProductModal() { if (loggedInUser?.isAdmin) openModal(getEl('add-product-modal')); }
        function closeAddProductModal() { closeModal(getEl('add-product-modal')); }
        function showProductDetails(id) {
            const p=products.find(x=>x.id===id); if(!p)return;
            detailModalProductId = id;
            const q=cart.find(x=>x.id===id)?.quantity||0;
            const info=getStockDisplayInfo(p.stock,q,p.isTokenCard);
            setTxt('detail-name', p.name); getEl('detail-image').src=p.image_url; setTxt('detail-id', p.id); setTxt('detail-price', p.price);
            getEl('detail-stock-available').innerHTML=info.text; getEl('detail-stock-available').className=info.cssClass;
            getEl('detail-add-to-cart').onclick=()=>addToCart(id, getEl('detail-qty').value);
            getEl('detail-buy-now').onclick=()=>{addToCart(id, getEl('detail-qty').value);viewCart();}
            openModal(getEl('product-detail-modal'));
        }
        function closeProductDetails() { closeModal(getEl('product-detail-modal')); }

        // --- INIT ---
        window.onload = async () => {
            loadCart();
            checkLoginStatus();
            loadProducts();
            getEl('search').addEventListener('input', debounce(applyFiltersAndSort, 300));
            getEl('prev').onclick=()=>{if(currentPage>1){currentPage--;renderProducts()}};
            getEl('next').onclick=()=>{const t=Math.ceil(filteredProducts.length/itemsPerPage);if(currentPage<t){currentPage++;renderProducts()}};
        };
    </script>
</body>

</html>