<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Limo Gangs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Rajdhani', sans-serif; background-color: #050505; color: #e5e5e5; overflow-x: hidden; }
        .cyber-grid { position: fixed; inset: 0; z-index: -1; background-image: linear-gradient(rgba(139, 92, 246, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(139, 92, 246, 0.05) 1px, transparent 1px); background-size: 40px 40px; mask-image: radial-gradient(circle at center, black 40%, transparent 100%); }
        .font-mono { font-family: 'Share Tech Mono', monospace; }
        
        .panel { background: rgba(15, 15, 20, 0.95); border: 1px solid #333; box-shadow: 0 0 20px rgba(0,0,0,0.5); backdrop-filter: blur(5px); }
        .panel-header { background: rgba(139, 92, 246, 0.1); border-bottom: 1px solid rgba(139, 92, 246, 0.3); padding: 10px 15px; font-weight: bold; text-transform: uppercase; letter-spacing: 2px; color: #a78bfa; display: flex; justify-content: space-between; align-items: center; }
        
        .chat-container { height: 400px; overflow-y: auto; display: flex; flex-direction: column-reverse; padding: 15px; gap: 8px; background: #0a0a0a; }
        .msg { font-size: 0.9rem; padding: 5px 10px; border-left: 2px solid #333; animation: fadeIn 0.2s; }
        .msg.private { border-color: #8b5cf6; background: rgba(139, 92, 246, 0.05); }
        .msg.system { border-color: #ef4444; color: #ef4444; font-weight: bold; }
        .tag-badge { background: #333; color: #fff; padding: 0 4px; border-radius: 2px; font-size: 0.7rem; margin-right: 5px; font-family: monospace; }
        
        .btn-cyber { background: #111; border: 1px solid #8b5cf6; color: #8b5cf6; text-transform: uppercase; font-weight: bold; padding: 8px 16px; transition: all 0.2s; cursor: pointer; clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px); }
        .btn-cyber:hover { background: #8b5cf6; color: #000; box-shadow: 0 0 15px rgba(139, 92, 246, 0.5); }
        .btn-cyber:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
        .btn-gold { border-color: #f59e0b; color: #f59e0b; } .btn-gold:hover { background: #f59e0b; color: #000; box-shadow: 0 0 15px rgba(245, 158, 11, 0.5); }
        
        .input-cyber { background: #050505; border: 1px solid #333; color: white; padding: 8px; width: 100%; font-family: 'Share Tech Mono', monospace; outline: none; transition: border-color 0.3s; }
        .input-cyber:focus { border-color: #8b5cf6; }
        
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: #000; } ::-webkit-scrollbar-thumb { background: #333; }
        @keyframes fadeIn { from { opacity: 0; transform: translateX(-5px); } to { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body class="p-2 md:p-6 min-h-screen flex flex-col">

    <div class="cyber-grid"></div>

    <header class="flex justify-between items-center mb-6 border-b border-gray-800 pb-4">
        <div class="flex items-center gap-4">
            <button onclick="window.location.href='/'" class="text-gray-500 hover:text-white text-xl">‚¨Ö</button>
            <div>
                <h1 class="text-3xl font-bold uppercase tracking-widest text-white">Limo <span class="text-violet-500">Gangs</span></h1>
                <p class="text-xs text-gray-500 font-mono tracking-widest">SYNDICATE WARS v4.0</p>
            </div>
        </div>
        <div id="user-status" class="text-right">
            <div class="text-gray-500 text-xs uppercase">Dein Geld</div>
            <div class="text-violet-400 font-mono text-xl" id="my-balance">Lade...</div>
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 flex-grow">

        <div class="lg:col-span-1 space-y-6">
            
            <div id="view-no-gang" class="hidden">
                <div class="panel p-6 text-center border-t-4 border-t-violet-600">
                    <h2 class="text-2xl font-bold text-white mb-2">Keine Zugeh√∂rigkeit</h2>
                    <p class="text-gray-400 text-sm mb-6">Gr√ºnde ein Syndikat oder tritt einem bei, um Gebiete zu erobern.</p>
                    <div class="bg-black/50 p-4 border border-gray-800 mb-4 text-left">
                        <label class="text-xs text-gray-500 uppercase">Gang Name</label>
                        <input type="text" id="create-name" class="input-cyber mb-2" placeholder="Die Void Runner">
                        <label class="text-xs text-gray-500 uppercase">Tag (2-4 Zeichen)</label>
                        <input type="text" id="create-tag" class="input-cyber mb-4 uppercase" placeholder="VOID" maxlength="4">
                        <button onclick="createGang()" class="btn-cyber w-full">GR√úNDEN ($5 Mio)</button>
                    </div>
                </div>
            </div>

            <div id="view-in-gang" class="hidden">
                <div class="panel border-t-4 border-t-violet-500 mb-6">
                    <div class="p-6 text-center bg-gradient-to-b from-violet-900/20 to-transparent relative">
                        <div id="gang-badges" class="absolute top-2 right-2 flex gap-1 cursor-help"></div>
                        
                        <h2 class="text-4xl font-bold text-white mb-1" id="gang-name">-</h2>
                        <span class="bg-violet-600 text-black px-2 py-0.5 font-bold text-xs rounded" id="gang-tag">-</span>
                    </div>
                    
                    <div class="grid grid-cols-2 border-t border-gray-800">
                        <div class="p-4 text-center border-r border-gray-800">
                            <div class="text-gray-500 text-xs uppercase">Kriegskasse</div>
                            <div class="text-2xl text-yellow-400 font-mono" id="gang-balance">$0</div>
                        </div>
                        <div class="p-4 text-center">
                            <div class="text-gray-500 text-xs uppercase">Mitglieder</div>
                            <div class="text-2xl text-white font-mono" id="gang-members-count">0/10</div>
                        </div>
                    </div>

                    <div class="p-4 bg-black/30">
                        <label class="text-xs text-gray-500 uppercase">Einzahlen</label>
                        <div class="flex gap-2 mt-1">
                            <input type="number" id="deposit-amount" class="input-cyber" placeholder="Betrag">
                            <button onclick="depositMoney()" class="btn-cyber btn-gold">PAY</button>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-header">Mitglieder</div>
                    <div id="member-list" class="p-2 space-y-1 max-h-60 overflow-y-auto">
                        </div>
                    <div class="p-2 border-t border-gray-800">
                        <button onclick="leaveGang()" class="w-full text-xs text-red-500 hover:text-red-400 py-2 border border-red-900/50 hover:bg-red-900/20 transition">GANG VERLASSEN</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="lg:col-span-2 flex flex-col h-[600px] lg:h-auto panel relative">
            
            <div class="flex border-b border-gray-800">
                <button onclick="switchTab('public')" id="tab-public" class="flex-1 py-3 text-sm font-bold uppercase bg-violet-900/20 text-white border-b-2 border-violet-500 transition">üåê Global</button>
                <button onclick="switchTab('private')" id="tab-private" class="flex-1 py-3 text-sm font-bold uppercase text-gray-500 border-b-2 border-transparent transition">üîí Intern</button>
                <button onclick="switchTab('shop')" id="tab-shop" class="flex-1 py-3 text-sm font-bold uppercase text-yellow-600 border-b-2 border-transparent transition">üèóÔ∏è Imperium</button>
            </div>

            <div id="section-chat" class="flex-grow flex flex-col h-full">
                <div id="chat-window" class="chat-container flex-grow">
                    <div class="text-center text-gray-600 mt-10">Verbinde zum Netzwerk...</div>
                </div>
                <div class="p-3 bg-black/50 border-t border-gray-800 flex gap-2">
                    <input type="text" id="chat-input" class="input-cyber" placeholder="Nachricht..." onkeypress="if(event.key==='Enter') sendMessage()">
                    <button onclick="sendMessage()" class="btn-cyber">SEND</button>
                </div>
            </div>

            <div id="section-shop" class="hidden flex-grow p-6 overflow-y-auto">
                <h2 class="text-2xl text-yellow-500 mb-4 font-bold uppercase tracking-widest">Schwarzmarkt Upgrades</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="border border-gray-700 bg-black/40 p-4 relative group">
                        <div class="absolute top-0 right-0 bg-gray-800 text-xs px-2 py-1 text-gray-400">DEFENSE</div>
                        <h3 class="text-xl text-white font-bold">Bunkeranlage</h3>
                        <p class="text-xs text-gray-400 mb-4 h-10">Sch√ºtzt 50% der Beute bei verlorenen Angriffen.</p>
                        <div class="flex justify-between items-center">
                            <span class="text-yellow-500 font-mono">$10.0M</span>
                            <button onclick="buyUpgrade('bunker')" class="btn-cyber text-xs">KAUFEN</button>
                        </div>
                    </div>
                    <div class="border border-gray-700 bg-black/40 p-4 relative group">
                        <div class="absolute top-0 right-0 bg-gray-800 text-xs px-2 py-1 text-gray-400">DEFENSE</div>
                        <h3 class="text-xl text-white font-bold">Star-Anwalt</h3>
                        <p class="text-xs text-gray-400 mb-4 h-10">Erh√∂ht die Chance, Angriffe abzuwehren (+20%).</p>
                        <div class="flex justify-between items-center">
                            <span class="text-yellow-500 font-mono">$25.0M</span>
                            <button onclick="buyUpgrade('lawyer')" class="btn-cyber text-xs">KAUFEN</button>
                        </div>
                    </div>
                    <div class="border border-gray-700 bg-black/40 p-4 relative group">
                        <div class="absolute top-0 right-0 bg-red-900 text-xs px-2 py-1 text-white">ATTACK</div>
                        <h3 class="text-xl text-white font-bold">Waffenlager</h3>
                        <p class="text-xs text-gray-400 mb-4 h-10">Massive Feuerkraft f√ºr Angriffe (+20% Winrate).</p>
                        <div class="flex justify-between items-center">
                            <span class="text-yellow-500 font-mono">$50.0M</span>
                            <button onclick="buyUpgrade('weapons')" class="btn-cyber text-xs">KAUFEN</button>
                        </div>
                    </div>
                </div>

                <hr class="border-gray-800 my-8">

                <h2 class="text-2xl text-violet-500 mb-4 font-bold uppercase tracking-widest flex items-center gap-2">
                    <span>üåç</span> Territorium Kontrolle (24h)
                </h2>
                
                <div id="zones-list" class="space-y-4">
                    <div class="text-center text-gray-500">Lade Karte...</div>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-6 panel p-4">
        <h3 class="text-violet-400 font-bold uppercase mb-4 text-sm tracking-widest border-b border-gray-800 pb-2">Top Syndikate & Kriegsf√ºhrung</h3>
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left">
                <thead class="text-gray-500 text-xs uppercase">
                    <tr>
                        <th class="p-2">Rang</th>
                        <th class="p-2">Tag</th>
                        <th class="p-2">Name</th>
                        <th class="p-2 text-right">Verm√∂gen</th>
                        <th class="p-2 text-center">Member</th>
                        <th class="p-2 text-right">Aktion</th>
                    </tr>
                </thead>
                <tbody id="top-gangs-list" class="divide-y divide-gray-800">
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        const API_URL = 'https://api.limazon.v6.rocks'; 
        let currentTab = 'public'; 
        let isInGang = false;
        let isLeader = false;
        let myGangId = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadDashboard();
            setInterval(loadDashboard, 3000); 
        });

        async function loadDashboard() {
            try {
                const res = await fetch(`${API_URL}/api/gangs/dashboard`, { credentials: 'include' });
                const data = await res.json();
                if(res.ok) {
                    isInGang = data.inGang;
                    if(isInGang) {
                        isLeader = data.gang.isLeader;
                        myGangId = data.gang.id;
                    }
                    updateUIState(data);
                    renderChat(data);
                    renderZones(data.zones);
                    renderTopGangs(data.topGangs);
                }
            } catch(e) {}
        }

        function updateUIState(data) {
            // Balance anzeigen
            if(data.userBalance !== undefined) document.getElementById('my-balance').innerText = '$ ' + data.userBalance.toLocaleString();
            
            if (isInGang) {
                document.getElementById('view-no-gang').classList.add('hidden');
                document.getElementById('view-in-gang').classList.remove('hidden');
                
                const g = data.gang;
                document.getElementById('gang-name').innerText = g.name;
                document.getElementById('gang-tag').innerText = g.tag;
                document.getElementById('gang-balance').innerText = '$ ' + g.balance.toLocaleString();
                document.getElementById('gang-members-count').innerText = g.members.length + '/10';

                // --- UPGRADES ANZEIGEN & SHOP BUTTONS SPERREN ---
                const badgesContainer = document.getElementById('gang-badges');
                badgesContainer.innerHTML = "";
                const upgrades = g.upgrades || {};

                // Badges
                if(upgrades.bunker) badgesContainer.innerHTML += `<span title="Bunker" class="text-xl">üõ°Ô∏è</span>`;
                if(upgrades.lawyer) badgesContainer.innerHTML += `<span title="Anwalt" class="text-xl">‚öñÔ∏è</span>`;
                if(upgrades.weapons) badgesContainer.innerHTML += `<span title="Waffen" class="text-xl">‚öîÔ∏è</span>`;

                // Shop Buttons Logik
                const updateShopBtn = (type) => {
                    const btn = document.querySelector(`button[onclick="buyUpgrade('${type}')"]`);
                    if(btn) {
                        if(upgrades[type]) {
                            btn.innerText = "BESITZ";
                            btn.disabled = true;
                            btn.className = "btn-cyber border-green-600 text-green-600 cursor-default opacity-50";
                        } else {
                            btn.innerText = "KAUFEN";
                            btn.disabled = false;
                            btn.className = "btn-cyber text-xs";
                        }
                    }
                };
                updateShopBtn('bunker');
                updateShopBtn('lawyer');
                updateShopBtn('weapons');

                // Members
                const list = document.getElementById('member-list');
                list.innerHTML = g.members.map(m => {
                    const kickBtn = (isLeader && m._id !== g.leaderId) ? 
                        `<button onclick="kickMember('${m._id}')" class="text-[10px] text-red-500 border border-red-900 px-1 hover:bg-red-900 ml-2">KICK</button>` : '';
                    const promoBtn = (isLeader && m._id !== g.leaderId) ? 
                        `<button onclick="promoteMember('${m._id}')" class="text-[10px] text-yellow-500 border border-yellow-900 px-1 hover:bg-yellow-900">üëë</button>` : '';
                    
                    return `
                    <div class="flex justify-between items-center bg-black/30 p-2 rounded border border-gray-800">
                        <span class="font-bold text-sm ${m._id === g.leaderId ? 'text-yellow-500' : 'text-gray-300'}">
                            ${m._id === g.leaderId ? 'üëë' : ''} ${m.username}
                        </span>
                        <div class="flex gap-1">${promoBtn}${kickBtn}</div>
                    </div>`;
                }).join('');

            } else {
                // Not in Gang
                document.getElementById('view-no-gang').classList.remove('hidden');
                document.getElementById('view-in-gang').classList.add('hidden');
                if(currentTab === 'private' || currentTab === 'shop') switchTab('public');
                document.getElementById('tab-private').disabled = true;
                document.getElementById('tab-shop').disabled = true;
            }
        }

        function renderZones(zones) {
            const container = document.getElementById('zones-list');
            if(!zones) return;

            container.innerHTML = zones.map(z => {
                let statusHtml = "";
                let btnHtml = "";

                if (z.isTaken) {
                    const myTag = document.getElementById('gang-tag').innerText;
                    const isOurs = isInGang && z.ownerTag === myTag;
                    
                    if (isOurs) {
                        statusHtml = `<span class="text-green-500 font-bold border border-green-900 bg-green-900/20 px-2 py-1 text-xs rounded">EIGENTUM</span>`;
                        btnHtml = `<button class="btn-cyber text-xs opacity-50 cursor-not-allowed border-green-600 text-green-600">GESICHERT</button>`;
                    } else {
                        statusHtml = `<span class="text-red-500 font-bold border border-red-900 bg-red-900/20 px-2 py-1 text-xs rounded">VON [${z.ownerTag}]</span>`;
                        // Time calculation
                        const left = Math.ceil((new Date(z.expiresAt) - new Date()) / 60000 / 60);
                        btnHtml = `<button class="btn-cyber text-xs opacity-50 cursor-not-allowed border-red-900 text-red-900">FREI IN ${left}h</button>`;
                    }
                } else {
                    statusHtml = `<span class="text-gray-400 border border-gray-700 bg-black px-2 py-1 text-xs rounded">VERF√úGBAR</span>`;
                    if (isLeader) {
                        btnHtml = `<button onclick="rentZone('${z.id}')" class="btn-cyber btn-gold text-xs">MIETEN</button>`;
                    } else {
                        btnHtml = `<button class="btn-cyber text-xs opacity-50" disabled>NUR LEADER</button>`;
                    }
                }

                return `
                <div class="flex items-center justify-between bg-black/40 border border-gray-800 p-4 rounded hover:border-violet-500/50 transition">
                    <div class="flex items-center gap-4">
                        <div class="text-4xl filter drop-shadow-[0_0_10px_rgba(139,92,246,0.3)]">${z.icon}</div>
                        <div>
                            <h3 class="text-lg text-white font-bold uppercase">${z.name}</h3>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-yellow-500 font-mono text-xs">$${(z.cost/1000000).toFixed(1)}M / 24h</span>
                                ${statusHtml}
                            </div>
                        </div>
                    </div>
                    <div>${btnHtml}</div>
                </div>`;
            }).join('');
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('button[id^="tab-"]').forEach(b => {
                b.className = "flex-1 py-3 text-sm font-bold uppercase text-gray-500 border-b-2 border-transparent hover:text-gray-300 transition";
            });
            const activeBtn = document.getElementById(`tab-${tab}`);
            let color = "violet"; 
            if(tab === 'shop') color = "yellow";
            activeBtn.className = `flex-1 py-3 text-sm font-bold uppercase bg-${color}-900/20 text-white border-b-2 border-${color}-500 transition`;

            if(tab === 'shop') {
                document.getElementById('section-chat').classList.add('hidden');
                document.getElementById('section-shop').classList.remove('hidden');
            } else {
                document.getElementById('section-chat').classList.remove('hidden');
                document.getElementById('section-shop').classList.add('hidden');
                loadDashboard(); 
            }
        }

        function renderChat(data) {
            if(currentTab === 'shop') return;
            const msgs = currentTab === 'public' ? data.publicChat : (data.gang ? data.gang.privateChat : []);
            const container = document.getElementById('chat-window');
            let html = "";
            if(msgs.length === 0) html = `<div class="text-center text-gray-600 mt-10 opacity-50">Keine Nachrichten...</div>`;
            else {
                const displayMsgs = [...msgs].reverse(); 
                html = displayMsgs.map(m => {
                    const time = new Date(m.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    const isSystem = m.sender === 'SYSTEM' || m.sender === 'WAR-BOT';
                    const tagHtml = m.tag ? `<span class="tag-badge">${m.tag}</span>` : '';
                    return `
                    <div class="msg ${currentTab === 'private' ? 'private' : ''} ${isSystem ? 'system' : ''}">
                        <div class="flex items-baseline gap-2 mb-1">
                            <span class="text-xs text-gray-600 font-mono">[${time}]</span>
                            ${tagHtml}
                            <span class="font-bold text-xs ${isSystem ? '' : 'text-gray-300'}">${m.sender}:</span>
                        </div>
                        <div class="text-gray-200 break-words">${m.msg}</div>
                    </div>`;
                }).join('');
            }
            if(container.innerHTML !== html) { container.innerHTML = html; container.scrollTop = container.scrollHeight; }
        }

        // --- API CALLS ---
        async function apiCall(endpoint, body) {
            try {
                const res = await fetch(`${API_URL}/api/gangs/${endpoint}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body), credentials: 'include'
                });
                const d = await res.json();
                if(res.ok) { 
                    if(d.message) alert(d.message); 
                    loadDashboard(); 
                } else alert(d.error);
            } catch(e) { alert("Verbindungsfehler"); }
        }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if(!msg) return;
            input.value = "";
            apiCall('chat', { message: msg, type: currentTab });
        }
        function createGang() {
            const name = document.getElementById('create-name').value;
            const tag = document.getElementById('create-tag').value;
            if(confirm(`Gang gr√ºnden?`)) apiCall('create', { name, tag });
        }
        function depositMoney() {
            const amount = document.getElementById('deposit-amount').value;
            apiCall('deposit', { amount });
            document.getElementById('deposit-amount').value = "";
        }
        function leaveGang() { if(confirm("Wirklich verlassen?")) apiCall('leave', {}); }
        function kickMember(id) { if(confirm("Kicken?")) apiCall('kick', { targetId: id }); }
        function promoteMember(id) { if(confirm("Zum Leader machen?")) apiCall('promote', { targetId: id }); }
        function buyUpgrade(type) { if(confirm("Upgrade kaufen?")) apiCall('upgrade', { type }); }
        function attackGang(id) {
            if(!confirm("Krieg erkl√§ren und angreifen? (1h Cooldown)")) return;
            apiCall('attack', { targetGangId: id });
        }
        function rentZone(id) {
            if(!confirm("Zone mieten f√ºr 24h?")) apiCall('rent-zone', { zoneId: id });
        }
        function joinGang(id) { if(confirm("Beitreten?")) apiCall('join', { gangId: id }); }

        function renderTopGangs(list) {
            const tbody = document.getElementById('top-gangs-list');
            if(list.length === 0) { tbody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-gray-600">Leer...</td></tr>`; return; }
            tbody.innerHTML = list.map((g, i) => {
                let actionBtn = "";
                if (!isInGang) actionBtn = `<button onclick="joinGang('${g._id}')" class="text-xs bg-violet-900 text-violet-200 px-2 py-1 rounded hover:bg-violet-600">JOIN</button>`;
                else if (g._id !== myGangId) actionBtn = `<button onclick="attackGang('${g._id}')" class="text-xs bg-red-900 text-red-200 px-2 py-1 rounded hover:bg-red-600 border border-red-500 font-bold">‚öîÔ∏è ATTACK</button>`;

                let rankColor = i===0 ? "text-yellow-400 font-bold" : "text-gray-500";
                return `
                <tr class="hover:bg-white/5 transition border-b border-gray-800">
                    <td class="p-2 ${rankColor}">#${i+1}</td>
                    <td class="p-2 font-mono font-bold text-violet-400">[${g.tag}]</td>
                    <td class="p-2 font-bold text-white">${g.name}</td>
                    <td class="p-2 text-right font-mono text-yellow-500">$${(g.balance/1000000).toFixed(1)}M</td>
                    <td class="p-2 text-center text-gray-400 text-xs">${g.memberCount}/10</td>
                    <td class="p-2 text-right">${actionBtn}</td>
                </tr>`;
            }).join('');
        }
    </script>
</body>
</html>