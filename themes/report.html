<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Limazon Wirtschaftspr√ºfungsbericht</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @media print {
            .no-print { display: none; }
            body { background: white; color: black; padding: 0; }
            .report-card { border: 1px solid #ddd; box-shadow: none; break-inside: avoid; }
        }
        body { background-color: #f8fafc; color: #1e293b; font-family: sans-serif; }
        .report-card { background: white; border-radius: 12px; padding: 24px; border: 1px solid #e2e8f0; }
        .chart-container { position: relative; height: 300px; width: 100%; }
    </style>
</head>
<body class="p-4 md:p-10">

    <div class="max-w-5xl mx-auto">
        <div class="no-print flex justify-between items-center mb-8 bg-slate-900 p-4 rounded-2xl text-white shadow-2xl border border-white/10">
            <div>
                <h1 class="font-bold text-lg">Finanz-Audit Generator</h1>
                <p class="text-[10px] text-slate-400 uppercase tracking-widest">Version 4.0 - Master Admin</p>
            </div>
            <div class="flex gap-3">
                <button onclick="window.location.reload()" class="bg-slate-800 hover:bg-slate-700 px-4 py-2 rounded-lg text-sm transition-all">üîÑ Aktualisieren</button>
                <button onclick="window.print()" class="bg-indigo-600 hover:bg-indigo-500 px-6 py-2 rounded-lg text-sm font-bold shadow-lg shadow-indigo-500/20 transition-all">üñ®Ô∏è PDF Export</button>
            </div>
        </div>

        <div id="report-content" class="space-y-6">
            <div class="text-center py-20 opacity-50" id="loader">
                <div class="animate-spin h-8 w-8 border-4 border-indigo-600 border-t-transparent rounded-full mx-auto mb-4"></div>
                Sammle globale Wirtschaftsdaten...
            </div>
        </div>
    </div>

    <script>
        const API = 'https://api.limazon.v6.rocks';

        async function loadReportData() {
            try {
                const res = await fetch(API + '/api/admin/system/report', { credentials: 'include' });
                if (!res.ok) throw new Error("Nicht autorisiert. Bitte im Admin-Panel einloggen.");
                const data = await res.json();
                renderReport(data);
            } catch (e) {
                document.getElementById('report-content').innerHTML = `
                    <div class="bg-red-50 border-l-4 border-red-500 text-red-700 p-6 rounded-xl shadow-sm">
                        <p class="font-bold">Zugriff verweigert</p>
                        <p class="text-sm">${e.message}</p>
                    </div>`;
            }
        }

        function renderReport(data) {
            const dateStr = new Date(data.timestamp).toLocaleString('de-DE', {
                day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'
            });

            const html = `
                <div class="bg-white p-10 border-b-8 border-indigo-600 rounded-t-3xl shadow-sm">
                    <div class="flex justify-between items-end">
                        <div>
                            <h1 class="text-4xl font-black tracking-tighter text-slate-900">LIMAZON<span class="text-indigo-600">.</span>ECONOMY</h1>
                            <p class="text-xs font-black text-slate-400 uppercase tracking-[0.3em] mt-1">Wirtschafts-Pr√ºfungsbericht</p>
                        </div>
                        <div class="text-right text-[10px] text-slate-400 font-mono leading-relaxed">
                            REF-ID: ${Math.random().toString(36).substr(2, 9).toUpperCase()}<br>
                            DATUM: ${dateStr}<br>
                            STATUS: OFFIZIELL VERIFIZIERT
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
                    <div class="report-card">
                        <p class="text-[10px] uppercase font-bold text-slate-400 mb-1">Geldmenge (Total)</p>
                        <p class="text-xl font-bold text-slate-800">$${data.stats.economy.totalMoney.toLocaleString()}</p>
                    </div>
                    <div class="report-card">
                        <p class="text-[10px] uppercase font-bold text-slate-400 mb-1">Staatsreserve</p>
                        <p class="text-xl font-bold text-indigo-600">$${data.stats.economy.treasury.toLocaleString()}</p>
                    </div>
                    <div class="report-card">
                        <p class="text-[10px] uppercase font-bold text-slate-400 mb-1">Steueraufkommen</p>
                        <p class="text-xl font-bold text-emerald-600">$${data.stats.economy.totalTaxesPaid.toLocaleString()}</p>
                    </div>
                    <div class="report-card">
                        <p class="text-[10px] uppercase font-bold text-slate-400 mb-1">Nutzerbasis</p>
                        <p class="text-xl font-bold text-slate-800">${data.stats.users}</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div class="report-card">
                        <h3 class="text-xs font-bold uppercase text-slate-500 mb-4">Geldverteilung (User vs. Staat)</h3>
                        <div class="chart-container">
                            <canvas id="moneyChart"></canvas>
                        </div>
                    </div>
                    <div class="report-card">
                        <h3 class="text-xs font-bold uppercase text-slate-500 mb-4">Top 10 Verm√∂gensvergleich</h3>
                        <div class="chart-container">
                            <canvas id="wealthChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="report-card mt-6">
                    <h3 class="text-sm font-bold border-b border-slate-100 pb-3 mb-4 flex justify-between items-center">
                        <span>Top 10 Global Wealth Ranking</span>
                        <span class="text-[10px] font-normal text-slate-400">Sortiert nach Liquiden Mitteln</span>
                    </h3>
                    <table class="w-full text-left text-sm">
                        <thead>
                            <tr class="text-slate-400 border-b border-slate-50">
                                <th class="py-3 px-2">Rang</th>
                                <th class="py-3">Nutzername</th>
                                <th class="py-3 text-right">Barverm√∂gen</th>
                                <th class="py-3 text-right">Tokens</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.stats.topUsers.map((u, i) => `
                                <tr class="border-t border-slate-50 hover:bg-slate-50/50 transition-colors">
                                    <td class="py-4 px-2 font-bold text-slate-300">#${i+1}</td>
                                    <td class="py-4 font-bold text-slate-700 underline decoration-indigo-200 decoration-2 underline-offset-4">${u.username}</td>
                                    <td class="py-4 text-right font-mono text-emerald-600 font-bold">$${u.balance.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
                                    <td class="py-4 text-right font-bold text-slate-600">${(u.tokens || 0).toLocaleString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>

                <div class="text-center py-12 text-[9px] text-slate-400 uppercase tracking-[0.4em] font-bold">
                    *** Ende des Berichts - Limazon Federal Reserve ***
                </div>
            `;
            
            document.getElementById('report-content').innerHTML = html;

            // --- CHARTS INITIALISIEREN ---
            initCharts(data);
        }

        function initCharts(data) {
            // 1. Doughnut Chart: Verteilung
            new Chart(document.getElementById('moneyChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Nutzerverm√∂gen', 'Staatskasse'],
                    datasets: [{
                        data: [data.stats.economy.userMoney, data.stats.economy.treasury],
                        backgroundColor: ['#6366f1', '#10b981'],
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } } }
                }
            });

            // 2. Bar Chart: Top Users
            new Chart(document.getElementById('wealthChart'), {
                type: 'bar',
                data: {
                    labels: data.stats.topUsers.map(u => u.username),
                    datasets: [{
                        label: 'Guthaben in $',
                        data: data.stats.topUsers.map(u => u.balance),
                        backgroundColor: '#6366f1',
                        borderRadius: 5
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { display: false }, ticks: { font: { size: 9 } } },
                        x: { grid: { display: false }, ticks: { font: { size: 9 } } }
                    }
                }
            });
        }

        loadReportData();
    </script>
</body>
</html>