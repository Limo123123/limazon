<!DOCTYPE html><html lang="de"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tinda - Find your Match</title>
    <style>
        /* --- CSS STYLES (Update) --- */
        :root {
            --primary: #fe3c72;
            --secondary: #fd267d;
            --bg: #111418;
            --card-bg: #1f2329;
            --text: #ffffff;
            --text-muted: #888;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0; padding: 0;
            overflow: hidden; height: 100vh;
            display: flex; flex-direction: column;
        }

        /* Header */
        header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 20px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            box-shadow: 0 2px 10px rgba(0,0,0,0.3); z-index: 100;
        }
        .logo { font-weight: bold; font-size: 1.5rem; letter-spacing: -1px; }
        .nav-btn { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; opacity: 0.6; }
        .nav-btn.active { opacity: 1; text-shadow: 0 0 10px white; }

        /* Main */
        main { flex: 1; position: relative; overflow: hidden; display: flex; justify-content: center; align-items: center; }

        /* --- SWIPE VIEW --- */
        #swipe-view { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .card-container { position: relative; width: 90%; max-width: 400px; height: 60vh; }
        
        .tinda-card {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--card-bg); border-radius: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2); overflow: hidden;
            transition: transform 0.3s ease, opacity 0.3s ease;
            background-size: cover; background-position: center;
        }
        .card-info {
            position: absolute; bottom: 0; width: 100%;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            padding: 20px; box-sizing: border-box;
        }
        .card-info h2 { margin: 0; font-size: 2rem; }
        .card-info p { margin: 5px 0 0; color: #ddd; font-size: 1rem; }
        .card-info .bio { font-size: 0.9rem; color: #aaa; margin-top: 10px; font-style: italic; }

        .controls { display: flex; gap: 20px; margin-top: 20px; align-items: center; }
        .control-btn {
            width: 60px; height: 60px; border-radius: 50%; border: none;
            font-size: 2rem; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: flex; align-items: center; justify-content: center; transition: transform 0.1s;
        }
        .control-btn:active { transform: scale(0.9); }
        .btn-nope { background: #333; color: #ff4458; border: 2px solid #ff4458; }
        .btn-like { background: #333; color: #44db95; border: 2px solid #44db95; }
        .btn-reset { width: 40px; height: 40px; font-size: 1.2rem; background: #333; color: #ffca28; border: 1px solid #ffca28; }

        /* --- MATCHES VIEW --- */
        #matches-view { width: 100%; height: 100%; display: none; flex-direction: column; background: var(--bg); }
        
        .search-area { padding: 15px; background: #1f2329; border-bottom: 1px solid #333; }
        .search-input { width: 100%; padding: 10px; border-radius: 8px; border: none; background: #111; color: white; box-sizing: border-box; }
        .search-results { max-height: 150px; overflow-y: auto; background: #111; display: none; margin-top: 5px; border-radius: 8px; }
        .search-item { padding: 10px; border-bottom: 1px solid #333; cursor: pointer; display: flex; align-items: center; }
        .search-item img { width: 30px; height: 30px; border-radius: 50%; margin-right: 10px; object-fit: cover; }

        .match-list { overflow-y: auto; flex: 1; padding: 10px; }
        .match-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #333; cursor: pointer; }
        .match-item:hover { background: #1a1a1a; }
        .match-avatar { width: 50px; height: 50px; border-radius: 50%; background: #555; margin-right: 15px; object-fit: cover; }
        .match-info { flex: 1; }
        .match-name { font-weight: bold; font-size: 1.1rem; }
        .match-preview { color: var(--text-muted); font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }

        /* --- CHAT WINDOW --- */
        #chat-window {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); z-index: 200; display: none; flex-direction: column;
        }
        .chat-header { display: flex; align-items: center; padding: 15px; background: #1f2329; border-bottom: 1px solid #333; justify-content: space-between; }
        .chat-header-left { display: flex; align-items: center; }
        .back-btn { background: none; border: none; color: white; font-size: 1.5rem; margin-right: 15px; cursor: pointer; }
        .delete-chat-btn { background: none; border: none; color: #ff4458; font-size: 1.2rem; cursor: pointer; }
        
        .chat-messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .message { max-width: 70%; padding: 10px 15px; border-radius: 15px; font-size: 0.95rem; line-height: 1.4; }
        .msg-me { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        .msg-other { align-self: flex-start; background: #333; color: white; border-bottom-left-radius: 2px; }

        .chat-input-area { padding: 15px; background: #1f2329; display: flex; gap: 10px; }
        .chat-input { flex: 1; padding: 10px; border-radius: 20px; border: none; background: #111; color: white; }
        .send-btn { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; }

        /* Overlays & Loading */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 500; display: none; justify-content: center; align-items: center; flex-direction: column; text-align: center; }
        .match-popup h1 { font-size: 3rem; color: #44db95; transform: rotate(-10deg); margin-bottom: 20px; }
        .match-popup p { font-size: 1.2rem; margin-bottom: 30px; }
        .match-btn { padding: 10px 30px; border-radius: 25px; border: none; font-size: 1.1rem; cursor: pointer; background: var(--primary); color: white; }
        .empty-stack { text-align: center; color: #666; margin-top: 50px; }
        .loading { color: var(--primary); font-weight: bold; }
    </style>
</head>
<body>

    <header>
        <button class="nav-btn" onclick="showMatches()">üí¨</button>
        <div class="logo">üî• Tinda</div>
        <button class="nav-btn active" onclick="showSwipe()">üî•</button>
    </header>

    <main>
        <div id="swipe-view">
            <div class="card-container" id="stack-container">
                <div class="loading">Lade Profile...</div>
            </div>
            <div class="controls">
                <button class="control-btn btn-nope" onclick="swipe('left')">‚úñÔ∏è</button>
                <button class="control-btn btn-reset" onclick="resetNopes()" title="Reset Swipes">‚Üª</button>
                <button class="control-btn btn-like" onclick="swipe('right')">‚ù§Ô∏è</button>
            </div>
        </div>

        <div id="matches-view">
            <div class="search-area">
                <input type="text" class="search-input" placeholder="Suche Personen..." oninput="searchPeople(this.value)">
                <div class="search-results" id="search-results"></div>
            </div>
            <div class="match-list" id="match-list-container">
                </div>
        </div>
    </main>

    <div id="chat-window">
        <div class="chat-header">
            <div class="chat-header-left">
                <button class="back-btn" onclick="closeChat()">‚¨ÖÔ∏è</button>
                <img id="chat-header-img" class="match-avatar" src="" alt="">
                <div class="match-name" id="chat-header-name">Name</div>
            </div>
            <button class="delete-chat-btn" onclick="deleteCurrentChat()">üóëÔ∏è</button>
        </div>
        <div class="chat-messages" id="messages-container"></div>
        <div class="chat-input-area">
            <input type="text" class="chat-input" id="msg-input" placeholder="Schreib was..." onkeypress="handleEnter(event)">
            <button class="send-btn" onclick="sendMessage()">‚û§</button>
        </div>
    </div>

    <div id="match-overlay" class="overlay">
        <div class="match-popup">
            <h1>IT'S A MATCH!</h1>
            <p>Du und <span id="match-partner-name">...</span> m√∂gt euch.</p>
            <button class="match-btn" onclick="closeMatchPopup()">Weiter swipen</button>
            <br><br>
            <button class="match-btn" style="background:transparent; border: 1px solid white;" onclick="goToMatches()">Zum Chat</button>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const BACKEND_URL = 'https://api.limazon.v6.rocks'; // URL ANPASSEN!

        let stack = [];
        let currentCard = null;
        let activeChatId = null;
        let pollingInterval = null;

        async function api(endpoint, method = 'GET', body = null) {
            try {
                const options = { method, headers: { 'Content-Type': 'application/json' }, credentials: 'include' };
                if (body) options.body = JSON.stringify(body);
                const res = await fetch(`${BACKEND_URL}${endpoint}`, options);
                return await res.json();
            } catch (err) { console.error(err); return null; }
        }

        // --- SWIPE ---
        async function loadStack() {
            const container = document.getElementById('stack-container');
            container.innerHTML = '<div class="loading">Lade Profile...</div>';
            const data = await api('/api/tinda/stack');
            if (data && data.stack) {
                stack = data.stack;
                renderNextCard();
            } else {
                container.innerHTML = '<div class="empty-stack">Fehler beim Laden.</div>';
            }
        }

        function renderNextCard() {
            const container = document.getElementById('stack-container');
            if (stack.length === 0) {
                container.innerHTML = '<div class="empty-stack">Keine neuen Leute.<br>Klick auf ‚Üª um Reset zu machen! Oder probiere erst die Flamme oben rechts!</div>';
                currentCard = null;
                return;
            }
            currentCard = stack[0];
            const imgUrl = currentCard.image_url && currentCard.image_url.startsWith('http') ? currentCard.image_url : 'https://placehold.co/400x600/222/fff?text=No+Image';
            
            // Fix f√ºr Alter und Kategorie Anzeige
            const displayAge = currentCard.age ? `, ${currentCard.age}` : '';
            
            container.innerHTML = `
                <div class="tinda-card" style="background-image: url('${imgUrl}');">
                    <div class="card-info">
                        <h2>${currentCard.name}${displayAge}</h2>
                        <p>${currentCard.categoryId || 'Unbekannt'}</p>
                        <div class="bio">${currentCard.bio || ''}</div>
                        ${currentCard.averages && currentCard.totalAverage ? `<p style="color:#44db95">‚≠ê ${currentCard.totalAverage.toFixed(1)}</p>` : ''}
                    </div>
                </div>`;
        }

        async function swipe(direction) {
            if (!currentCard) return;
            const cardEl = document.querySelector('.tinda-card');
            cardEl.style.transform = direction === 'left' ? 'translate(-150%, 20px) rotate(-30deg)' : 'translate(150%, 20px) rotate(30deg)';
            cardEl.style.opacity = '0';
            
            api('/api/tinda/swipe', 'POST', { humanId: currentCard._id, direction }).then(res => {
                if (res && res.match) showMatchPopup(res.humanName);
            });
            setTimeout(() => { stack.shift(); renderNextCard(); }, 300);
        }

        // --- RESET FEATURE ---
        async function resetNopes() {
            if(!confirm("Willst du alle Leute zur√ºckholen, die du weggeswiped hast?")) return;
            const res = await api('/api/tinda/reset-swipes', 'POST');
            alert(res.message);
            loadStack();
        }

        // --- MATCHES & SEARCH ---
        async function loadMatches() {
            const container = document.getElementById('match-list-container');
            container.innerHTML = '<div class="loading">Lade Chats...</div>';
            const data = await api('/api/chat/chats');
            if (data && data.chats) {
                const tindaChats = data.chats.filter(c => c.type === 'tinda');
                if (tindaChats.length === 0) {
                    container.innerHTML = '<div class="empty-stack">Noch keine Matches.</div>';
                    return;
                }
                container.innerHTML = tindaChats.map(chat => {
                    const img = 'https://placehold.co/50x50/333/fff?text=' + chat.tindaPartnerName.charAt(0);
                    return `
                        <div class="match-item" onclick="openChat('${chat._id}', '${chat.tindaPartnerName}')">
                            <img class="match-avatar" src="${img}">
                            <div class="match-info">
                                <div class="match-name">${chat.tindaPartnerName}</div>
                                <div class="match-preview">${chat.lastMessagePreview || '...'}</div>
                            </div>
                        </div>`;
                }).join('');
            }
        }

        // --- SEARCH FUNCTION ---
        let searchTimeout;
        function searchPeople(term) {
            clearTimeout(searchTimeout);
            const resultsDiv = document.getElementById('search-results');
            if(term.length < 2) { resultsDiv.style.display = 'none'; return; }
            
            searchTimeout = setTimeout(async () => {
                const data = await api(`/api/tinda/search?q=${term}`);
                if(data && data.results && data.results.length > 0) {
                    resultsDiv.innerHTML = data.results.map( p => `
                        <div class="search-item" onclick="startDirectChat('${p._id}')">
                            <img src="${p.image_url && p.image_url.startsWith('http') ? p.image_url : 'https://placehold.co/30/333/fff?text=' + p.name.charAt(0)}">
                            <span>${p.name} (${p.categoryId || 'Human'})</span>
                        </div>
                    `).join('');
                    resultsDiv.style.display = 'block';
                } else {
                    resultsDiv.style.display = 'none';
                }
            }, 300);
        }

        async function startDirectChat(humanId) {
            document.getElementById('search-results').style.display = 'none';
            document.querySelector('.search-input').value = '';
            const res = await api('/api/tinda/match/direct', 'POST', { humanId });
            if(res && res.success) {
                openChat(res.chat._id, res.chat.tindaPartnerName);
            } else {
                alert("Fehler beim Starten des Chats.");
            }
        }

        // --- CHAT ---
        async function openChat(chatId, name) {
            activeChatId = chatId;
            document.getElementById('chat-window').style.display = 'flex';
            document.getElementById('chat-header-name').innerText = name;
            document.getElementById('chat-header-img').src = 'https://placehold.co/50x50/333/fff?text=' + name.charAt(0);
            await loadMessages();
            if (pollingInterval) clearInterval(pollingInterval);
            pollingInterval = setInterval(loadMessages, 3000);
        }

        async function deleteCurrentChat() {
            if(!activeChatId) return;
            if(!confirm("Diesen Chat und das Match wirklich l√∂schen?")) return;
            
            await api(`/api/tinda/chat/${activeChatId}`, 'DELETE');
            closeChat();
        }

        async function loadMessages() {
            if (!activeChatId) return;
            const data = await api(`/api/chat/chats/${activeChatId}/messages?limit=20`);
            if (data && data.messages) {
                const container = document.getElementById('messages-container');
                const shouldScroll = container.scrollTop + container.clientHeight >= container.scrollHeight - 50;
                container.innerHTML = data.messages.map(msg => {
                    const style = msg.isAi ? 'msg-other' : 'msg-me';
                    return `<div class="message ${style}">${msg.content}</div>`;
                }).join('');
                if (shouldScroll) container.scrollTop = container.scrollHeight;
            }
        }

        async function sendMessage() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if (!text || !activeChatId) return;
            input.value = '';
            const container = document.getElementById('messages-container');
            container.innerHTML += `<div class="message msg-me" style="opacity:0.5">${text}</div>`;
            container.scrollTop = container.scrollHeight;
            await api(`/api/tinda/chat/${activeChatId}/message`, 'POST', { content: text });
            loadMessages();
        }

        function closeChat() {
            document.getElementById('chat-window').style.display = 'none';
            activeChatId = null;
            if (pollingInterval) clearInterval(pollingInterval);
            loadMatches();
        }

        function showMatchPopup(name) { document.getElementById('match-partner-name').innerText = name; document.getElementById('match-overlay').style.display = 'flex'; }
        function closeMatchPopup() { document.getElementById('match-overlay').style.display = 'none'; }
        function goToMatches() { closeMatchPopup(); showMatches(); }
        function handleEnter(e) { if (e.key === 'Enter') sendMessage(); }

        function showSwipe() {
            document.getElementById('swipe-view').style.display = 'flex';
            document.getElementById('matches-view').style.display = 'none';
            document.querySelectorAll('.nav-btn')[0].classList.remove('active');
            document.querySelectorAll('.nav-btn')[1].classList.add('active');
            loadStack();
        }
        function showMatches() {
            document.getElementById('swipe-view').style.display = 'none';
            document.getElementById('matches-view').style.display = 'flex';
            document.querySelectorAll('.nav-btn')[0].classList.add('active');
            document.querySelectorAll('.nav-btn')[1].classList.remove('active');
            loadMatches();
        }

        window.onload = () => loadStack();
    </script>

</body></html>