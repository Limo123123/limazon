<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Limazon Netzwerk & Wirtschaft</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .stat-card { transition: all 0.2s ease; }
        .stat-card:hover { transform: translateY(-3px); background-color: rgba(30, 41, 59, 0.9); border-color: rgba(99, 102, 241, 0.5); box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.3); }
        
        button:disabled { opacity: 0.3; cursor: not-allowed; }
        .shadow-glow-green { box-shadow: 0 0 12px rgba(16, 185, 129, 0.4); }
        .shadow-glow-red { box-shadow: 0 0 12px rgba(239, 68, 68, 0.4); }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }

        @keyframes pulse-red { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-live { animation: pulse-red 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }

        /* Easter Egg 1: Shake Animation f√ºr Wut-Klick */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .animate-shake { animation: shake 0.5s; }

        /* Easter Egg 2: Matrix Canvas Hintergrund */
        #matrix-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0; transition: opacity 2s; }
        .matrix-active #matrix-canvas { opacity: 0.3; }
        .matrix-active .text-emerald-400 { color: #00ff41 !important; text-shadow: 0 0 10px #00ff41; }
        .matrix-active .text-indigo-400 { color: #00ff41 !important; }
        .matrix-active .bg-indigo-600 { background-color: #008f11 !important; }

        /* Toast Benachrichtigung */
        #toast { transition: bottom 0.3s, opacity 0.3s; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen p-6 relative overflow-x-hidden">

    <canvas id="matrix-canvas"></canvas>

    <div id="white-rabbit" class="fixed inset-0 flex items-center justify-center pointer-events-none z-[200] opacity-0 transition-opacity duration-1000">
        <span class="text-[200px] drop-shadow-[0_0_50px_rgba(255,255,255,0.8)]">üêá</span>
    </div>

    <div class="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20 pointer-events-none"></div>
    <div class="absolute top-0 left-0 w-full h-96 bg-gradient-to-b from-indigo-900/20 to-transparent pointer-events-none" id="top-gradient"></div>

    <div class="max-w-6xl mx-auto relative z-10">
        
        <nav class="flex justify-between items-center mb-12">
            <a href="/" class="text-slate-400 hover:text-white font-bold transition">‚Üê Hub</a>
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2 bg-red-500/10 px-3 py-1 rounded-full border border-red-500/30">
                    <div class="w-2 h-2 bg-red-500 rounded-full animate-live"></div>
                    <span class="text-red-400 font-mono text-xs font-bold tracking-widest">LIVE DATA</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 bg-emerald-500 rounded-full animate-pulse"></div>
                    <span id="system-status-text" class="text-emerald-400 font-mono text-sm">SYSTEM OPERATIONAL</span>
                </div>
            </div>
        </nav>

        <div class="text-center mb-12">
            <h1 class="text-4xl md:text-6xl font-extrabold mb-4 bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-cyan-400" id="main-title">
                Netzwerk Zentrale
            </h1>
            <p class="text-slate-400">Echtzeit-Metriken, Datenbank-Status und Live-B√∂rsenkurse der Limazon Cloud.</p>
        </div>

        <div class="glass rounded-3xl p-8 mb-8 flex flex-col md:flex-row items-center justify-around text-center md:text-left gap-8">
            <div>
                <h3 class="text-slate-400 text-sm uppercase tracking-widest font-bold mb-2">Gesamte Codebasis</h3>
                <div class="text-6xl font-extrabold mono text-white" id="stat-loc-total">---</div>
                <p class="text-slate-500 text-sm mt-2">Zeilen Code (LOC)</p>
            </div>
            <div class="h-px w-full md:w-px md:h-24 bg-slate-700"></div>
            <div class="grid grid-cols-2 gap-x-12 gap-y-4">
                <div>
                    <div class="text-2xl font-bold mono text-indigo-400" id="stat-loc-server">---</div>
                    <div class="text-xs text-slate-500 uppercase">Server (Backend)</div>
                </div>
                <div>
                    <div class="text-2xl font-bold mono text-pink-400" id="stat-loc-front">---</div>
                    <div class="text-xs text-slate-500 uppercase">Web (Frontend)</div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
            <div class="glass stat-card p-6 rounded-2xl cursor-pointer" onclick="openDataModal('users')">
                <div class="flex justify-between items-start mb-4">
                    <div class="p-3 bg-indigo-500/10 rounded-xl text-indigo-400 text-2xl">üë•</div>
                    <span class="text-xs font-bold bg-slate-800 px-2 py-1 rounded text-slate-400">DB: Users</span>
                </div>
                <div class="text-4xl font-bold text-white mb-1" id="stat-users">0</div>
                <p class="text-indigo-400 text-sm hover:underline">Alle anzeigen ‚Üí</p>
            </div>

            <div class="glass stat-card p-6 rounded-2xl cursor-pointer" onclick="openDataModal('products')">
                <div class="flex justify-between items-start mb-4">
                    <div class="p-3 bg-blue-500/10 rounded-xl text-blue-400 text-2xl">üõí</div>
                    <span class="text-xs font-bold bg-slate-800 px-2 py-1 rounded text-slate-400">DB: Products</span>
                </div>
                <div class="text-4xl font-bold text-white mb-1" id="stat-products">0</div>
                <p class="text-blue-400 text-sm hover:underline">Alle anzeigen ‚Üí</p>
            </div>

            <div class="glass stat-card p-6 rounded-2xl cursor-pointer" onclick="openDataModal('humans')">
                <div class="flex justify-between items-start mb-4">
                    <div class="p-3 bg-lime-500/10 rounded-xl text-lime-400 text-2xl">üéì</div>
                    <span class="text-xs font-bold bg-slate-800 px-2 py-1 rounded text-slate-400">DB: Humans</span>
                </div>
                <div class="text-4xl font-bold text-white mb-1" id="stat-humans">0</div>
                <p class="text-lime-400 text-sm hover:underline">Alle anzeigen ‚Üí</p>
            </div>

            <div class="glass stat-card p-6 rounded-2xl cursor-pointer" onclick="openDataModal('wheels')">
                <div class="flex justify-between items-start mb-4">
                    <div class="p-3 bg-purple-500/10 rounded-xl text-purple-400 text-2xl">üé°</div>
                    <span class="text-xs font-bold bg-slate-800 px-2 py-1 rounded text-slate-400">DB: Wheels</span>
                </div>
                <div class="text-4xl font-bold text-white mb-1" id="stat-wheels">0</div>
                <p class="text-purple-400 text-sm hover:underline">Alle anzeigen ‚Üí</p>
            </div>
        </div>

        <div class="glass rounded-2xl p-6 mb-12">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <h2 class="text-2xl font-extrabold text-indigo-400 flex items-center gap-2" id="stock-title">üìà Limo Aktienmarkt</h2>
                <div class="flex items-center gap-4">
                    <span id="result-count" class="text-sm text-slate-500 font-mono">0 gefunden</span>
                    <input type="text" id="searchInput" placeholder="Suche nach Name oder ID..." class="bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 focus:outline-none focus:border-indigo-500 w-full md:w-64 transition">
                </div>
            </div>

            <div id="product-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="text-slate-500 text-center col-span-full py-12">Lade Produkte...</div>
            </div>

            <div class="flex justify-center items-center gap-6 mt-8 p-4 bg-slate-900/50 rounded-xl border border-slate-800" id="pagination-controls">
                <button id="btn-prev" onclick="changePage(-1)" class="bg-slate-800 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg transition disabled:opacity-30 disabled:cursor-not-allowed">‚Üê Zur√ºck</button>
                <span class="text-slate-400 font-mono text-sm">Seite <span id="page-current" class="text-white font-bold text-lg">1</span> von <span id="page-total">1</span></span>
                <button id="btn-next" onclick="changePage(1)" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg transition disabled:opacity-30 disabled:cursor-not-allowed">Weiter ‚Üí</button>
            </div>
        </div>

    </div>

    <div id="chart-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center">
        <div class="glass w-full max-w-4xl p-8 rounded-2xl relative m-4">
            <button onclick="closeChartModal()" class="absolute top-4 right-4 bg-slate-800 hover:bg-red-500/80 text-white rounded-full w-8 h-8 flex items-center justify-center transition">‚úï</button>
            <h3 class="text-2xl font-bold mb-1" id="chart-title">Produkt Name</h3>
            <p class="text-slate-400 text-sm mb-6" id="chart-subtitle">Live Aktienkurs-Verlauf</p>
            
            <div id="chart-container" class="w-full h-80 cursor-crosshair" onclick="handleRageClick()"></div>
        </div>
    </div>

    <div id="data-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center">
        <div class="glass w-full max-w-4xl p-8 rounded-2xl relative m-4 h-[80vh] flex flex-col">
            <button onclick="closeDataModal()" class="absolute top-4 right-4 bg-slate-800 hover:bg-red-500/80 text-white rounded-full w-8 h-8 flex items-center justify-center transition z-50">‚úï</button>
            
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6 pr-10">
                <div class="flex items-center gap-3">
                    <span class="text-3xl" id="data-modal-icon">üîç</span>
                    <div>
                        <h3 class="text-2xl font-bold" id="data-modal-title">Daten</h3>
                        <p class="text-slate-400 text-sm" id="data-modal-subtitle">Alle Eintr√§ge aus der Datenbank</p>
                    </div>
                </div>
                <input type="text" id="modalSearchInput" placeholder="Suchen..." class="bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 focus:outline-none focus:border-indigo-500 w-full md:w-64 transition">
            </div>

            <div id="data-list-container" class="flex-1 overflow-y-auto space-y-2 pr-2 bg-slate-900/50 p-4 rounded-xl border border-slate-800"></div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-[-100px] left-1/2 transform -translate-x-1/2 bg-red-900/90 border border-red-500 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 z-[100] backdrop-blur-md opacity-0 font-bold">
        <span id="toast-icon">‚ö†Ô∏è</span> <span id="toast-message">Nachricht</span>
    </div>

    <script>
        // API ENDPOINTS
        const BASE_URL = 'https://api.limazon.v6.rocks';
        const API_STATS = `${BASE_URL}/api/system/stats`;
        const API_PRODUCTS = `${BASE_URL}/api/products`;
        const API_HISTORY_BASE = `${BASE_URL}/api/products/`;
        const API_USERS = `${BASE_URL}/api/admin/users`; 
        const API_HUMANS = `${BASE_URL}/api/human/list`;
        const API_WHEELS = `${BASE_URL}/api/wheels/public`;

        // GLOBALE VARIABLEN
        let allProducts = [];
        let filteredProducts = [];
        let chartInstance = null;
        let currentPage = 1;
        const ITEMS_PER_PAGE = 12;

        let currentModalData = [];
        let currentModalType = '';

        const COLOR_UP = '#10b981'; const COLOR_DOWN = '#ef4444'; const COLOR_NEUTRAL = '#6366f1';

        // --- EASTER EGG LOGIK: KONAMI CODE ---
        const konamiCode = ['ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'ArrowLeft', 'ArrowRight', 'b', 'a'];
        let konamiIndex = 0;
        document.addEventListener('keydown', (e) => {
            if (e.key === konamiCode[konamiIndex]) {
                konamiIndex++;
                if (konamiIndex === konamiCode.length) {
                    activateMatrixMode();
                    konamiIndex = 0;
                }
            } else { konamiIndex = 0; }
        });

        function activateMatrixMode() {
            // 1. Das Kaninchen erscheint kurz
            const rabbit = document.getElementById('white-rabbit');
            rabbit.style.opacity = "1";
            
            // 2. Nach 1.5 Sekunden startet die Matrix
            setTimeout(() => {
                rabbit.style.opacity = "0";
                document.body.classList.add('matrix-active');
                document.getElementById('system-status-text').innerText = "SIMULATION ACTIVE";
                document.getElementById('top-gradient').classList.replace('from-indigo-900/20', 'from-emerald-900/50');
                showToast("Matrix Modus aktiviert. Folge dem wei√üen Kaninchen.", "emerald", "üêá");
                startMatrixRain();
            }, 1500);
        }

        // --- EASTER EGG LOGIK: RAGE CLICK (Jetzt auf dem Diagramm selbst) ---
        let rageClicks = 0;
        let rageTimer;
        function handleRageClick() {
            rageClicks++;
            clearTimeout(rageTimer);
            
            // Bei 5 Klicks im Diagramm rastet der Bildschirm aus
            if (rageClicks >= 5) {
                document.body.classList.add('animate-shake');
                showToast("Beruhig dich! Klicks bringen den Kurs auch nicht wieder hoch. üìâ", "red", "‚ö†Ô∏è");
                setTimeout(() => document.body.classList.remove('animate-shake'), 500);
                rageClicks = 0;
            } else {
                rageTimer = setTimeout(() => rageClicks = 0, 800);
            }
        }

        function showToast(msg, color = "red", icon = "‚ö†Ô∏è") {
            const toast = document.getElementById('toast');
            document.getElementById('toast-message').innerText = msg;
            document.getElementById('toast-icon').innerText = icon;
            toast.className = `fixed bottom-[-100px] left-1/2 transform -translate-x-1/2 border text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 z-[100] backdrop-blur-md opacity-0 font-bold ${color === 'red' ? 'bg-red-900/90 border-red-500' : 'bg-emerald-900/90 border-emerald-500'}`;
            
            toast.style.bottom = "40px";
            toast.style.opacity = "1";
            setTimeout(() => { toast.style.bottom = "-100px"; toast.style.opacity = "0"; }, 3500);
        }

        // --- NORMALER CODE START ---
        function animateValue(obj, start, end, duration) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start).toLocaleString();
                if (progress < 1) { window.requestAnimationFrame(step); }
            };
            window.requestAnimationFrame(step);
        }

        async function loadStats() {
            try {
                const res = await fetch(API_STATS);
                const d = await res.json();
                document.getElementById('stat-loc-total').innerText = d.loc.total.toLocaleString();
                document.getElementById('stat-loc-server').innerText = d.loc.server.toLocaleString();
                document.getElementById('stat-loc-front').innerText = d.loc.frontend.toLocaleString();
                animateValue(document.getElementById('stat-users'), 0, d.users, 1000);
                animateValue(document.getElementById('stat-products'), 0, d.products, 1000);
                animateValue(document.getElementById('stat-humans'), 0, d.humans, 1000);
                animateValue(document.getElementById('stat-wheels'), 0, d.wheels, 1000);
            } catch(e) { console.error(e); }
        }

        async function loadProducts() {
            try {
                const res = await fetch(API_PRODUCTS);
                const d = await res.json();
                allProducts = d.products.filter(p => !p.isTokenCard);
                applyMainSearch(); 
            } catch(e) { console.error(e); }
        }

        function applyMainSearch() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            
            // EASTER EGG 2: ID-1337 GEISTER-AKTIE
            if (term === '1337' || term === 'liminati') {
                renderSecretStock();
                return;
            }

            filteredProducts = allProducts.filter(p => p.name.toLowerCase().includes(term) || p.id.toString().includes(term));
            document.getElementById('result-count').innerText = `${filteredProducts.length} gefunden`;
            document.getElementById('pagination-controls').style.display = 'flex';
            renderPage();
        }

        function renderSecretStock() {
            const grid = document.getElementById('product-grid');
            grid.innerHTML = '';
            document.getElementById('result-count').innerText = "1 Geheimnis gefunden";
            document.getElementById('pagination-controls').style.display = 'none';

            const card = document.createElement('div');
            card.className = "stat-card bg-purple-900/50 border border-purple-500 p-4 rounded-xl flex items-center gap-4 cursor-pointer shadow-glow-green";
            card.onclick = () => openSecretChart();

            card.innerHTML = `
                <div class="w-12 h-12 rounded-lg bg-black border border-purple-500 flex items-center justify-center text-2xl">üëÅÔ∏è</div>
                <div class="flex-1 min-w-0">
                    <div class="font-bold text-white truncate text-purple-300">Limo Server-Anteile</div>
                    <div class="text-xs text-purple-400">ID: 1337</div>
                </div>
                <div class="flex items-stretch gap-3 text-right">
                    <div>
                        <div class="font-mono text-emerald-400 font-bold">‚àû USD</div>
                        <div class="text-xs text-emerald-400 opacity-80 animate-pulse">TO THE MOON üöÄ</div>
                    </div>
                    <div class="w-1.5 rounded-full bg-emerald-500 shadow-glow-green"></div>
                </div>
            `;
            grid.appendChild(card);
        }

        function openSecretChart() {
            document.getElementById('chart-modal').classList.remove('hidden');
            document.getElementById('chart-title').innerText = "Limo Server-Anteile (ID: 1337)";
            document.getElementById('chart-subtitle').innerText = "Server-Herzschlag (Anomalie entdeckt)";
            document.getElementById('chart-container').innerHTML = '';

            const secretData = [];
            let time = Date.now() - 300000;
            for(let i=0; i<30; i++) {
                const val = Math.sin(i) * 100 + 1000;
                secretData.push({ x: time + (i*10000), y: val });
            }

            if (chartInstance) chartInstance.destroy();

            chartInstance = new ApexCharts(document.querySelector("#chart-container"), {
                series: [{ name: 'Server Pulse', data: secretData }],
                chart: { type: 'area', height: 320, background: 'transparent', toolbar: { show: false }, animations: { enabled: true, easing: 'linear', dynamicAnimation: { speed: 1000 } } },
                theme: { mode: 'dark' },
                stroke: { curve: 'smooth', width: 3, colors: ['#a855f7'] },
                fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.7, opacityTo: 0.2, stops: [0, 100], colorStops: [{ offset: 0, color: '#a855f7', opacity: 0.8 }, { offset: 100, color: '#000000', opacity: 0 }] } },
                grid: { borderColor: '#334155', strokeDashArray: 4 },
                xaxis: { type: 'datetime', labels: { style: { colors: '#94a3b8' } } },
                yaxis: { labels: { style: { colors: '#94a3b8' } }, tooltip: { enabled: true } },
                dataLabels: { enabled: false }
            });
            chartInstance.render();
        }

        function renderPage() {
            const grid = document.getElementById('product-grid');
            grid.innerHTML = '';
            const productsToShow = filteredProducts.slice((currentPage - 1) * ITEMS_PER_PAGE, ((currentPage - 1) * ITEMS_PER_PAGE) + ITEMS_PER_PAGE);

            if(productsToShow.length === 0) {
                grid.innerHTML = '<div class="text-slate-500 text-center col-span-full py-12">Keine Produkte.</div>';
            } else {
                productsToShow.forEach(prod => {
                    const card = document.createElement('div');
                    card.className = "stat-card bg-slate-800/50 border border-slate-700 p-4 rounded-xl flex items-center gap-4 cursor-pointer";
                    card.onclick = () => openChart(prod.id);
                    
                    const currentPrice = prod.currentPrice !== undefined ? prod.currentPrice : 0;
                    let previousPrice = prod.basePrice !== undefined ? prod.basePrice : currentPrice;
                    if (prod.priceHistory && prod.priceHistory.length > 1) {
                        previousPrice = prod.priceHistory[prod.priceHistory.length - 2].price;
                    }

                    const isPositiveTrend = currentPrice >= previousPrice; 
                    let changePercent = previousPrice > 0 ? ((currentPrice - previousPrice) / previousPrice) * 100 : 0;

                    const trendColorText = isPositiveTrend ? 'text-emerald-400' : 'text-red-400';
                    const trendBarBg = isPositiveTrend ? 'bg-emerald-500' : 'bg-red-500';
                    const trendShadow = isPositiveTrend ? 'shadow-glow-green' : 'shadow-glow-red';

                    card.innerHTML = `
                        <img src="${prod.image_url}" class="w-12 h-12 rounded-lg object-cover bg-slate-900 border border-slate-700">
                        <div class="flex-1 min-w-0">
                            <div class="font-bold text-white truncate">${prod.name}</div>
                            <div class="text-xs text-slate-400">ID: ${prod.id}</div>
                        </div>
                        <div class="flex items-stretch gap-3 text-right">
                            <div>
                                <div class="font-mono ${trendColorText} font-bold">$${currentPrice.toFixed(2)}</div>
                                <div class="text-xs ${trendColorText} opacity-80">${isPositiveTrend ? '‚ñ≤' : '‚ñº'} ${Math.abs(changePercent).toFixed(1)}%</div>
                            </div>
                            <div class="w-1.5 rounded-full ${trendBarBg} ${trendShadow}"></div>
                        </div>
                    `;
                    grid.appendChild(card);
                });
            }
            updatePaginationControls();
        }

        function updatePaginationControls() {
            const totalPages = Math.ceil(filteredProducts.length / ITEMS_PER_PAGE) || 1;
            if (currentPage > totalPages) currentPage = totalPages;
            document.getElementById('page-current').innerText = currentPage;
            document.getElementById('page-total').innerText = totalPages;
            document.getElementById('btn-prev').disabled = (currentPage === 1);
            document.getElementById('btn-next').disabled = (currentPage >= totalPages);
        }

        function changePage(step) {
            currentPage += step;
            renderPage();
            document.getElementById('searchInput').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        document.getElementById('searchInput').addEventListener('input', () => {
            currentPage = 1; 
            applyMainSearch();
        });

        // --- NORMALES CHART √ñFFNEN ---
        async function openChart(productId) {
            document.getElementById('chart-modal').classList.remove('hidden');
            document.getElementById('chart-title').innerText = "Lade Daten...";
            document.getElementById('chart-subtitle').innerText = "Live Aktienkurs-Verlauf";
            document.getElementById('chart-container').innerHTML = '';

            try {
                const res = await fetch(`${API_HISTORY_BASE}${productId}/history`);
                const data = await res.json();
                document.getElementById('chart-title').innerText = data.name;

                const chartData = data.history.map(entry => ({ x: new Date(entry.timestamp).getTime(), y: entry.price }));

                let chartColor = COLOR_NEUTRAL;
                if (chartData.length > 1) {
                    chartColor = chartData[chartData.length - 1].y >= chartData[chartData.length - 2].y ? COLOR_UP : COLOR_DOWN;
                }

                if (chartInstance) chartInstance.destroy();

                chartInstance = new ApexCharts(document.querySelector("#chart-container"), {
                    series: [{ name: 'Preis ($)', data: chartData }],
                    chart: { type: 'area', height: 320, background: 'transparent', toolbar: { show: false }, animations: { enabled: false } },
                    theme: { mode: 'dark' },
                    stroke: { curve: 'smooth', width: 3, colors: [chartColor] },
                    fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.5, opacityTo: 0.1, stops: [0, 90, 100], colorStops: [{ offset: 0, color: chartColor, opacity: 0.6 }, { offset: 100, color: chartColor, opacity: 0.1 }] } },
                    grid: { borderColor: '#334155', strokeDashArray: 4 },
                    xaxis: { type: 'datetime', labels: { style: { colors: '#94a3b8' } } },
                    yaxis: { labels: { formatter: (value) => "$" + value.toFixed(2), style: { colors: '#94a3b8' } }, tooltip: { enabled: true } },
                    dataLabels: { enabled: false }
                });
                chartInstance.render();

            } catch(e) { document.getElementById('chart-title').innerText = "Fehler beim Laden des Charts"; }
        }

        function closeChartModal() { document.getElementById('chart-modal').classList.add('hidden'); }

        // --- DATA MODAL & SUCHEN ---
        async function openDataModal(type) {
            const modal = document.getElementById('data-modal');
            const listContainer = document.getElementById('data-list-container');
            const title = document.getElementById('data-modal-title');
            const icon = document.getElementById('data-modal-icon');
            const subtitle = document.getElementById('data-modal-subtitle');
            const searchInput = document.getElementById('modalSearchInput');

            modal.classList.remove('hidden');
            searchInput.value = '';
            listContainer.innerHTML = '<div class="text-center py-12 text-slate-500 animate-pulse">Lade Datenbank...</div>';
            currentModalType = type;

            try {
                if (type === 'products') { icon.innerText = "üõí"; title.innerText = "Alle Produkte"; subtitle.innerText = "Shop Inventar"; currentModalData = allProducts; } 
                else if (type === 'humans') { icon.innerText = "üéì"; title.innerText = "Alle Humans"; subtitle.innerText = "Human Grades Personen"; const res = await fetch(API_HUMANS); const data = await res.json(); currentModalData = data.humans || []; } 
                else if (type === 'wheels') { icon.innerText = "üé°"; title.innerText = "Gl√ºcksr√§der"; subtitle.innerText = "√ñffentliche Gl√ºcksr√§der"; const res = await fetch(API_WHEELS); const data = await res.json(); currentModalData = data.wheels || []; } 
                else if (type === 'users') { icon.innerText = "üë•"; title.innerText = "Alle Benutzer"; subtitle.innerText = "Registrierte Limazon Accounts"; const res = await fetch(API_USERS, { credentials: 'include' }); if (res.status === 401 || res.status === 403) { listContainer.innerHTML = `<div class="text-center py-12 text-red-400 bg-red-900/20 rounded-xl p-6">üîí Zugriff verweigert.</div>`; return; } const data = await res.json(); currentModalData = data.users || []; }
                renderDataList(currentModalData, currentModalType);
            } catch (err) { listContainer.innerHTML = '<div class="text-center py-12 text-red-500">Fehler beim Laden.</div>'; }
        }

        document.getElementById('modalSearchInput').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filteredData = currentModalData.filter(item => {
                if (currentModalType === 'users') return item.username.toLowerCase().includes(term);
                if (currentModalType === 'humans') return item.name.toLowerCase().includes(term);
                if (currentModalType === 'wheels') return item.name.toLowerCase().includes(term);
                if (currentModalType === 'products') return item.name.toLowerCase().includes(term) || item.id.toString().includes(term);
                return false;
            });
            renderDataList(filteredData, currentModalType);
        });

        function renderDataList(items, type) {
            const listContainer = document.getElementById('data-list-container');
            listContainer.innerHTML = '';
            if (items.length === 0) { listContainer.innerHTML = '<div class="text-center py-12 text-slate-500">Keine Eintr√§ge gefunden.</div>'; return; }

            items.forEach(item => {
                const row = document.createElement('div');
                row.className = "bg-slate-800 p-4 rounded-lg border border-slate-700 flex justify-between items-center";
                if (type === 'users') { row.innerHTML = `<div><div class="font-bold text-white">${item.username}</div><div class="text-xs text-slate-400">ID: ${item._id}</div></div><div class="text-right"><div class="text-emerald-400 font-mono">$${(item.balance || 0).toLocaleString()}</div></div>`; } 
                else if (type === 'humans') { row.innerHTML = `<div><div class="font-bold text-white">${item.name}</div></div><div class="text-right text-indigo-400 font-bold">‚àÖ ${(item.totalAverage || 0).toFixed(2)}</div>`; } 
                else if (type === 'wheels') { row.innerHTML = `<div><div class="font-bold text-white">${item.name}</div></div><div class="text-right text-white font-mono">${item.totalSpins || 0} Spins</div>`; } 
                else if (type === 'products') { row.innerHTML = `<div class="flex items-center gap-3"><img src="${item.image_url}" class="w-10 h-10 rounded object-cover"><div class="font-bold text-white">${item.name}</div></div><div class="text-emerald-400 font-mono">$${(item.currentPrice || 0).toFixed(2)}</div>`; }
                listContainer.appendChild(row);
            });
        }

        function closeDataModal() { document.getElementById('data-modal').classList.add('hidden'); }

        // --- MATRIX RAIN JS ---
        function startMatrixRain() {
            const canvas = document.getElementById('matrix-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            const letters = 'LIMAZON133701';
            const fontSize = 16;
            const columns = canvas.width / fontSize;
            const drops = Array(Math.floor(columns)).fill(1);

            function draw() {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#0F0';
                ctx.font = fontSize + 'px monospace';
                for (let i = 0; i < drops.length; i++) {
                    const text = letters[Math.floor(Math.random() * letters.length)];
                    ctx.fillText(text, i * fontSize, drops[i] * fontSize);
                    if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) drops[i] = 0;
                    drops[i]++;
                }
            }
            setInterval(draw, 33);
        }

        setInterval(async () => {
            try {
                const resStats = await fetch(API_STATS);
                const d = await resStats.json();
                document.getElementById('stat-users').innerText = d.users.toLocaleString();
                document.getElementById('stat-products').innerText = d.products.toLocaleString();
                document.getElementById('stat-humans').innerText = d.humans.toLocaleString();
                document.getElementById('stat-wheels').innerText = d.wheels.toLocaleString();
            } catch(e) {}
            loadProducts(); 
        }, 15000);

        loadStats();
        loadProducts();
    </script>
</body>
</html>