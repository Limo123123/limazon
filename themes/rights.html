<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Limo Admin - Rechteverwaltung</title>
    <style>
        :root {
            --bg-dark: #121212;
            --bg-panel: #1e1e1e;
            --primary: #4CAF50;
            --text-main: #ffffff;
            --text-muted: #aaaaaa;
            --border: #333333;
        }
        body {
            margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-dark); color: var(--text-main);
            display: flex; height: 100vh; overflow: hidden;
        }
        h1, h2, h3 { margin-top: 0; }
        
        /* Layout */
        .sidebar {
            width: 300px; background: var(--bg-panel); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; height: 100%;
        }
        .main-content {
            flex: 1; padding: 20px; overflow-y: auto; display: flex; justify-content: center;
        }
        
        /* Sidebar User List */
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); }
        .user-list { flex: 1; overflow-y: auto; padding: 10px; }
        .user-card {
            padding: 12px; background: #2a2a2a; border-radius: 8px; margin-bottom: 10px;
            cursor: pointer; transition: 0.2s; border: 1px solid transparent;
        }
        .user-card:hover { background: #333; }
        .user-card.active { border-color: var(--primary); background: #223322; }
        .user-name { font-weight: bold; font-size: 16px; }
        .user-role { font-size: 12px; color: var(--primary); margin-top: 4px; text-transform: uppercase; }

        /* Editor Panel */
        .editor-panel {
            background: var(--bg-panel); padding: 30px; border-radius: 12px;
            max-width: 600px; width: 100%; height: fit-content;
            border: 1px solid var(--border);
        }
        .empty-state { text-align: center; color: var(--text-muted); margin-top: 50px; }
        
        /* Form Elements */
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: var(--text-muted); }
        select {
            width: 100%; padding: 10px; background: #2a2a2a; color: white;
            border: 1px solid var(--border); border-radius: 6px; font-size: 16px;
        }
        
        /* Permissions Grid */
        .permissions-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;
            margin-top: 10px;
        }
        .perm-card {
            background: #2a2a2a; padding: 12px; border-radius: 8px;
            border: 1px solid var(--border); display: flex; align-items: flex-start; gap: 10px;
        }
        .perm-card.disabled { opacity: 0.5; pointer-events: none; }
        .perm-info { flex: 1; }
        .perm-title { font-weight: bold; font-size: 14px; margin-bottom: 4px; }
        .perm-desc { font-size: 12px; color: var(--text-muted); }
        
        /* Checkbox Styling */
        input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--primary); margin-top: 2px; }

        /* Button */
        .btn-save {
            background: var(--primary); color: white; border: none;
            padding: 12px 24px; font-size: 16px; border-radius: 6px;
            cursor: pointer; width: 100%; font-weight: bold; transition: 0.2s;
        }
        .btn-save:hover { background: #45a049; }

        /* Responsive (Tablets & Phones) */
        @media (max-width: 768px) {
            body { flex-direction: column; overflow: auto; }
            .sidebar { width: 100%; height: 30vh; border-right: none; border-bottom: 1px solid var(--border); }
            .main-content { height: 70vh; }
            .permissions-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Nutzer</h2>
            <input type="text" id="searchInput" placeholder="Suchen..." style="width: 100%; box-sizing: border-box; padding: 8px; border-radius: 4px; background: #2a2a2a; color: white; border: 1px solid var(--border);">
        </div>
        <div class="user-list" id="userList">
            </div>
    </div>

    <div class="main-content">
        <div class="editor-panel" id="editorPanel" style="display: none;">
            <h2 id="editUserName">Nutzer bearbeiten</h2>
            
            <div class="form-group">
                <label>Gruppe / Rolle</label>
                <select id="roleSelect"></select>
            </div>

            <div class="form-group">
                <label>Individuelle Rechte (Nur bei Rolle "Custom" wÃ¤hlbar)</label>
                <div class="permissions-grid" id="permissionsGrid">
                    </div>
            </div>

            <button class="btn-save" onclick="saveUser()">Speichern</button>
        </div>
        
        <div class="empty-state" id="emptyState">
            <h2>ðŸ‘ˆ WÃ¤hle einen Nutzer aus</h2>
        </div>
    </div>

    <script>
        // API Basis-URL direkt auf deine Domain gesetzt
        const API_BASE = 'https://api.limazon.v6.rocks/api/admin'; 
        
        let allUsers = [];
        let allRoles = [];
        let allPermissions = [];
        let selectedUserId = null;

        // Init
        async function init() {
            await Promise.all([fetchUsers(), fetchRoles(), fetchPermissions()]);
            renderUserList();
            renderRoleOptions();
            renderPermissionsGrid();
            
            // Suchfeld Event
            document.getElementById('searchInput').addEventListener('input', renderUserList);
            // Dropdown Event
            document.getElementById('roleSelect').addEventListener('change', handleRoleChange);
        }

        // --- Fetch Daten vom Server (MIT CREDENTIALS!) ---
        async function fetchUsers() {
            try {
                const res = await fetch(`${API_BASE}/users`, { credentials: 'include' });
                if (!res.ok) throw new Error("Unauthorized");
                const data = await res.json();
                allUsers = data.users || [];
            } catch (e) {
                console.error("Fehler beim Laden der Nutzer:", e);
                document.getElementById('userList').innerHTML = `<p style="color:red;">Fehler: Nicht eingeloggt oder keine Admin-Rechte.</p>`;
            }
        }

        async function fetchRoles() {
            try {
                const res = await fetch(`${API_BASE}/roles`, { credentials: 'include' });
                const data = await res.json();
                allRoles = data.roles || [];
            } catch (e) {
                console.error("Fehler beim Laden der Rollen:", e);
            }
        }

        async function fetchPermissions() {
            try {
                const res = await fetch(`${API_BASE}/permissions`, { credentials: 'include' });
                const data = await res.json();
                allPermissions = data.permissions || [];
            } catch (e) {
                console.error("Fehler beim Laden der Berechtigungen:", e);
            }
        }

        // --- Rendern ---
        function renderUserList() {
            const list = document.getElementById('userList');
            const search = document.getElementById('searchInput').value.toLowerCase();
            if (allUsers.length === 0) return; // Verhindert leeren Ãœberschreib-Fehler
            
            list.innerHTML = '';

            const filteredUsers = allUsers.filter(u => u.username.toLowerCase().includes(search));

            filteredUsers.forEach(user => {
                const div = document.createElement('div');
                div.className = `user-card ${user._id === selectedUserId ? 'active' : ''}`;
                
                // Legacy Fix: Wenn keine Rolle da ist, aber isAdmin = true, zeige Admin
                let displayRole = user.role || 'user';
                if (!user.role && user.isAdmin) displayRole = 'admin';

                div.innerHTML = `
                    <div class="user-name">${user.username}</div>
                    <div class="user-role">${displayRole}</div>
                `;
                div.onclick = () => selectUser(user);
                list.appendChild(div);
            });
        }

        function renderRoleOptions() {
            const select = document.getElementById('roleSelect');
            select.innerHTML = '';
            allRoles.forEach(role => {
                const opt = document.createElement('option');
                opt.value = role.id;
                opt.textContent = `${role.name} - ${role.description}`;
                select.appendChild(opt);
            });
        }

        function renderPermissionsGrid() {
            const grid = document.getElementById('permissionsGrid');
            grid.innerHTML = '';
            allPermissions.forEach(perm => {
                grid.innerHTML += `
                    <label class="perm-card" id="card_${perm.id}">
                        <input type="checkbox" value="${perm.id}" id="cb_${perm.id}">
                        <div class="perm-info">
                            <div class="perm-title">${perm.name}</div>
                            <div class="perm-desc">${perm.description}</div>
                        </div>
                    </label>
                `;
            });
        }

        // --- Logik ---
        function selectUser(user) {
            selectedUserId = user._id;
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('editorPanel').style.display = 'block';
            document.getElementById('editUserName').textContent = `Rechte fÃ¼r: ${user.username}`;
            
            // Setzte Rolle (Fallback logic fÃ¼r alte Admins)
            let userRole = user.role || 'user';
            if (!user.role && user.isAdmin) userRole = 'admin';
            
            document.getElementById('roleSelect').value = userRole;

            // Setze Checkboxen basierend auf User-Permissions
            const userPerms = user.permissions || [];
            allPermissions.forEach(perm => {
                const cb = document.getElementById(`cb_${perm.id}`);
                cb.checked = userPerms.includes(perm.id);
            });

            handleRoleChange(); // UI aktualisieren (Sperren/Entsperren)
            renderUserList(); // Aktiv-Klasse setzen
        }

        function handleRoleChange() {
            const currentRole = document.getElementById('roleSelect').value;
            const roleObj = allRoles.find(r => r.id === currentRole);
            
            allPermissions.forEach(perm => {
                const cb = document.getElementById(`cb_${perm.id}`);
                const card = document.getElementById(`card_${perm.id}`);
                
                if (currentRole === 'custom') {
                    // Custom: Checkboxen sind anklickbar, Zustand bleibt wie vom User gesetzt
                    card.classList.remove('disabled');
                    cb.disabled = false;
                } else {
                    // Vordefiniert: Checkboxen sperren und je nach Gruppen-Rechten anhaken
                    card.classList.add('disabled');
                    cb.disabled = true;
                    if (roleObj && (roleObj.permissions.includes('ALL') || roleObj.permissions.includes(perm.id))) {
                        cb.checked = true;
                    } else {
                        cb.checked = false;
                    }
                }
            });
        }

        async function saveUser() {
            if (!selectedUserId) return;
            const role = document.getElementById('roleSelect').value;
            
            // Sammle angehakte Permissions (NUR wichtig, wenn Custom)
            const permissions = [];
            if (role === 'custom') {
                allPermissions.forEach(perm => {
                    if (document.getElementById(`cb_${perm.id}`).checked) {
                        permissions.push(perm.id);
                    }
                });
            }

            const payload = { role: role };
            if (role === 'custom') payload.permissions = permissions;

            try {
                // HIER IST DER FIX: credentials: 'include' hinzugefÃ¼gt
                const res = await fetch(`${API_BASE}/users/${selectedUserId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(payload)
                });
                
                if (res.ok) {
                    alert('Erfolgreich gespeichert!');
                    await fetchUsers(); // Daten neu laden
                    selectUser(allUsers.find(u => u._id === selectedUserId)); // UI Refreshen
                } else {
                    const data = await res.json();
                    alert('Fehler: ' + data.error);
                }
            } catch (e) {
                alert('Netzwerkfehler');
            }
        }

        // Start
        init();
    </script>
</body>
</html>